<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>About Memory Barrier | Notes</title>
  <meta name="author" content="Shichao Yuan">
  
  <meta name="description" content="引言
什么是Memory Barrier？stackoverflow中有一个经典的回答：

For performance gains modern CPUs often execute instructions out of order to make maximum use of the ava">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="About Memory Barrier"/>
  <meta property="og:site_name" content="Notes"/>

  
    <meta property="og:image" content="undefined"/>
  

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  



</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">Notes</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">		
			<h1> About Memory Barrier</h1>
		</div>		
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <h2 id="引言">引言</h2>
<p>什么是Memory Barrier？stackoverflow中有一个经典的<a href="http://stackoverflow.com/questions/286629/what-is-a-memory-fence" target="_blank" rel="external">回答</a>：</p>
<blockquote>
<p>For performance gains modern CPUs often execute instructions out of order to make maximum use of the available silicon (including memory read/writes). Because the hardware enforces instructions integrity you never notice this in a single thread of execution. However for multiple threads or environments with volatile memory (memory mapped I/O for example) this can lead to unpredictable behavior.</p>
</blockquote>
<blockquote>
<p>A memory fence/barrier is a class of instructions that mean memory read/writes occur in the order you expect. For example a ‘full fence’ means all read/writes before the fence are comitted before those after the fence.</p>
</blockquote>
<blockquote>
<p>Note memory fences are a hardware concept. In higher level languages we are used to dealing with mutexes and semaphores - these may well be implemented using memory fences at the low level and explicit use of memory barriers are not necessary. Use of memory barriers requires a careful study of the hardware architecture and more commonly found in device drivers than application code.</p>
</blockquote>
<blockquote>
<p>The CPU reordering is different from compiler optimisations - although the artefacts can be similar. You need to take separate measures to stop the compiler reordering your instructions if that may cause undesirable behaviour (e.g. use of the volatile keyword in C).</p>
</blockquote>
<p>从高级语言编程的角度，理解与掌握Memory Barrier是容易的，但是对于硬件角度的Memory Barrier却有很多疑惑。所有笔者尝试通过本文自上而下将整个story串起来。</p>
<h2 id="幼稚的例子">幼稚的例子</h2>
<p>这个例子的思路来在一个带有cancel功能的GUI程序。（这种方式绝对的幼稚，但是本文的目的不在于cancel功能的实现，所以在下文也不会完善该功能，所做的改动仅仅是为了展示memory barrier）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemoryBarrierDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> cancel;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">                <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                        <span class="annotation">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">                                <span class="keyword">while</span> (!cancel) &#123;</span><br><span class="line">                                        i++;</span><br><span class="line">                                &#125;</span><br><span class="line">                                System.out.println(<span class="string">"Done!"</span>);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                &#125;).start();</span><br><span class="line"></span><br><span class="line">                System.out.println(<span class="string">"OS: "</span> + System.getProperty(<span class="string">"os.name"</span>) + <span class="string">" "</span> + System.getProperty(<span class="string">"os.arch"</span>) + <span class="string">"\n"</span></span><br><span class="line">                                + <span class="string">"JavaVersion: "</span> + System.getProperty(<span class="string">"java.version"</span>) + <span class="string">"\n"</span>);</span><br><span class="line">                Thread.sleep(<span class="number">2048</span>);</span><br><span class="line">                cancel = <span class="keyword">true</span>;</span><br><span class="line">                System.out.println(<span class="string">"flag cancel set to true"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>笔者只有一台古老的机器（Intel(R) Core(TM)2 Quad CPU Q6600 @ 2.40GHz），执行结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yuan@yuan-HP:~/learn$ jdk1.7.0_25/bin/java MemoryBarrierDemo&#10;OS: Linux amd64&#10;JavaVersion: 1.7.0_25&#10;&#10;flag cancel set to true</span><br></pre></td></tr></table></figure>
<p>程序一直处于循环递增<code>i</code>的状态，没有退出。也就是说程序中启动的子线程“看不到”主线程对共享变量<code>cancel</code>的改动，这就是从高级语言层面所看到的memory barrier，想要让子线程“看到”改变，那么就得让改变“穿过”memory barrier。</p>
<p>如何做？在_Java Concurrency in Practice_的3.1节介绍了两种方法——locking和volatile variable。在此我们试着用volatile关键字，将前面程序中的<code>private static boolean cancel;</code>改为<code>private static volatile boolean cancel;</code>。再次编译执行程序，结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yuan@yuan-HP:~/learn$ jdk1.7.0_25/bin/java MemoryBarrierDemo&#10;OS: Linux amd64&#10;JavaVersion: 1.7.0_25&#10;&#10;flag cancel set to true&#10;Done!&#10;yuan@yuan-HP:~/learn$</span><br></pre></td></tr></table></figure>
<p>如此程序就可以按照设想的那像正常退出了，很简单吧。</p>
<p>好的，下面就开始探索笔者困惑的部分了。</p>
<h2 id="汇编代码">汇编代码</h2>
<p>下面我们通过添加几个参数打印出反汇编的代码看看。</p>
<p>没有volatile的版本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yuan@yuan-HP:~/learn$ jdk1.7.0_25/bin/java -XX:+UnlockDiagnosticVMOptions -XX:+PrintAssembly MemoryBarrierDemo&#10;Java HotSpot(TM) 64-Bit Server VM warning: PrintAssembly is enabled; turning on DebugNonSafepoints to gain additional output&#10;OS: Linux amd64&#10;JavaVersion: 1.7.0_25&#10;&#10;Loaded disassembler from /home/yuan/learn/jdk1.7.0_25/jre/lib/amd64/hsdis-amd64.so&#10;Decoding compiled method 0x00007fbe883df890:&#10;Code:&#10;[Disassembling for mach=&#39;i386:x86-64&#39;]&#10;[Entry Point]&#10;[Verified Entry Point]&#10;[Constants]&#10;  # &#123;method&#125; &#39;access$000&#39; &#39;()Z&#39; in &#39;MemoryBarrierDemo&#39;&#10;  #           [sp+0x20]  (sp of caller)&#10;  0x00007fbe883df9c0: sub    $0x18,%rsp&#10;  0x00007fbe883df9c7: mov    %rbp,0x10(%rsp)    ;*synchronization entry&#10;                                                ; - MemoryBarrierDemo::access$000@-1 (line 1)&#10;  0x00007fbe883df9cc: mov    $0xebcfc590,%r10   ;   &#123;oop(a &#39;java/lang/Class&#39; = &#39;MemoryBarrierDemo&#39;)&#125;&#10;  0x00007fbe883df9d6: movzbl 0x70(%r10),%eax    ;*getstatic cancel&#10;                                                ; - MemoryBarrierDemo::access$000@0 (line 1)&#10;  0x00007fbe883df9db: add    $0x10,%rsp&#10;  0x00007fbe883df9df: pop    %rbp&#10;  0x00007fbe883df9e0: test   %eax,0x9c6b61a(%rip)        # 0x00007fbe9204b000&#10;                                                ;   &#123;poll_return&#125;&#10;  0x00007fbe883df9e6: retq&#10;  0x00007fbe883df9e7: hlt&#10;  0x00007fbe883df9e8: hlt&#10;  0x00007fbe883df9e9: hlt&#10;  0x00007fbe883df9ea: hlt&#10;  0x00007fbe883df9eb: hlt&#10;  0x00007fbe883df9ec: hlt&#10;  0x00007fbe883df9ed: hlt&#10;  0x00007fbe883df9ee: hlt&#10;  0x00007fbe883df9ef: hlt&#10;  0x00007fbe883df9f0: hlt&#10;  0x00007fbe883df9f1: hlt&#10;  0x00007fbe883df9f2: hlt&#10;  0x00007fbe883df9f3: hlt&#10;  0x00007fbe883df9f4: hlt&#10;  0x00007fbe883df9f5: hlt&#10;  0x00007fbe883df9f6: hlt&#10;  0x00007fbe883df9f7: hlt&#10;  0x00007fbe883df9f8: hlt&#10;  0x00007fbe883df9f9: hlt&#10;  0x00007fbe883df9fa: hlt&#10;  0x00007fbe883df9fb: hlt&#10;  0x00007fbe883df9fc: hlt&#10;  0x00007fbe883df9fd: hlt&#10;  0x00007fbe883df9fe: hlt&#10;  0x00007fbe883df9ff: hlt&#10;[Exception Handler]&#10;[Stub Code]&#10;  0x00007fbe883dfa00: jmpq   0x00007fbe883dc860  ;   &#123;no_reloc&#125;&#10;[Deopt Handler Code]&#10;  0x00007fbe883dfa05: callq  0x00007fbe883dfa0a&#10;  0x00007fbe883dfa0a: subq   $0x5,(%rsp)&#10;  0x00007fbe883dfa0f: jmpq   0x00007fbe883b6c00  ;   &#123;runtime_call&#125;&#10;  0x00007fbe883dfa14: hlt&#10;  0x00007fbe883dfa15: hlt&#10;  0x00007fbe883dfa16: hlt&#10;  0x00007fbe883dfa17: hlt&#10;Decoding compiled method 0x00007fbe883ddcd0:&#10;Code:&#10;[Entry Point]&#10;[Verified Entry Point]&#10;[Constants]&#10;  # &#123;method&#125; &#39;run&#39; &#39;()V&#39; in &#39;MemoryBarrierDemo$1&#39;&#10;  0x00007fbe883dde20: callq  0x00007fbe90e52370  ;   &#123;runtime_call&#125;&#10;  0x00007fbe883dde25: nopw   0x0(%rax,%rax,1)&#10;  0x00007fbe883dde30: mov    %eax,-0x14000(%rsp)&#10;  0x00007fbe883dde37: push   %rbp&#10;  0x00007fbe883dde38: sub    $0x10,%rsp&#10;  0x00007fbe883dde3c: mov    (%rsi),%ebx&#10;  0x00007fbe883dde3e: mov    %rsi,%rdi&#10;  0x00007fbe883dde41: mov    $0x7fbe90edf400,%r10&#10;  0x00007fbe883dde4b: callq  *%r10              ;*invokestatic access$000&#10;                                                ; - MemoryBarrierDemo$1::run@2 (line 10)&#10;  0x00007fbe883dde4e: mov    $0xebcfc590,%r10   ;   &#123;oop(a &#39;java/lang/Class&#39; = &#39;MemoryBarrierDemo&#39;)&#125;&#10;  0x00007fbe883dde58: movzbl 0x70(%r10),%r11d&#10;  0x00007fbe883dde5d: test   %r11d,%r11d&#10;  0x00007fbe883dde60: jne    0x00007fbe883dde6c  ;*goto&#10;                                                ; - MemoryBarrierDemo$1::run@11 (line 11)&#10;  0x00007fbe883dde62: inc    %ebx               ; OopMap&#123;off=68&#125;&#10;                                                ;*goto&#10;                                                ; - MemoryBarrierDemo$1::run@11 (line 11)&#10;  0x00007fbe883dde64: test   %eax,0x9c6d196(%rip)        # 0x00007fbe9204b000&#10;                                                ;*goto&#10;                                                ; - MemoryBarrierDemo$1::run@11 (line 11)&#10;                                                ;   &#123;poll&#125;&#10;  0x00007fbe883dde6a: jmp    0x00007fbe883dde62&#10;  0x00007fbe883dde6c: mov    $0xebcb0d10,%r10   ;   &#123;oop(a &#39;java/lang/Class&#39; = &#39;java/lang/System&#39;)&#125;&#10;  0x00007fbe883dde76: mov    0x74(%r10),%r11d   ;*getstatic out&#10;                                                ; - MemoryBarrierDemo$1::run@14 (line 13)&#10;  0x00007fbe883dde7a: test   %r11d,%r11d&#10;  0x00007fbe883dde7d: je     0x00007fbe883ddea0  ;*ifne&#10;                                                ; - MemoryBarrierDemo$1::run@5 (line 10)&#10;  0x00007fbe883dde7f: mov    %r11,%rsi          ;*getstatic out&#10;                                                ; - MemoryBarrierDemo$1::run@14 (line 13)&#10;  0x00007fbe883dde82: mov    $0xebd4b960,%rdx   ;   &#123;oop(&#34;Done!&#34;)&#125;&#10;  0x00007fbe883dde8c: xchg   %ax,%ax&#10;  0x00007fbe883dde8f: callq  0x00007fbe883b5c60  ; OopMap&#123;off=116&#125;&#10;                                                ;*invokevirtual println&#10;                                                ; - MemoryBarrierDemo$1::run@19 (line 13)&#10;                                                ;   &#123;optimized virtual_call&#125;&#10;  0x00007fbe883dde94: add    $0x10,%rsp&#10;  0x00007fbe883dde98: pop    %rbp&#10;  0x00007fbe883dde99: test   %eax,0x9c6d161(%rip)        # 0x00007fbe9204b000&#10;                                                ;   &#123;poll_return&#125;&#10;  0x00007fbe883dde9f: retq&#10;  0x00007fbe883ddea0: mov    $0xfffffff6,%esi&#10;  0x00007fbe883ddea5: xchg   %ax,%ax&#10;  0x00007fbe883ddea7: callq  0x00007fbe883b7020  ; OopMap&#123;off=140&#125;&#10;                                                ;*invokevirtual println&#10;                                                ; - MemoryBarrierDemo$1::run@19 (line 13)&#10;                                                ;   &#123;runtime_call&#125;&#10;  0x00007fbe883ddeac: callq  0x00007fbe90e52370  ;*invokevirtual println&#10;                                                ; - MemoryBarrierDemo$1::run@19 (line 13)&#10;                                                ;   &#123;runtime_call&#125;&#10;  0x00007fbe883ddeb1: mov    %rax,%rsi&#10;  0x00007fbe883ddeb4: add    $0x10,%rsp&#10;  0x00007fbe883ddeb8: pop    %rbp&#10;  0x00007fbe883ddeb9: jmpq   0x00007fbe883df5e0  ;*iinc&#10;                                                ; - MemoryBarrierDemo$1::run@8 (line 11)&#10;                                                ;   &#123;runtime_call&#125;&#10;  0x00007fbe883ddebe: callq  0x00007fbe90e52370  ;   &#123;runtime_call&#125;&#10;  0x00007fbe883ddec3: hlt&#10;  0x00007fbe883ddec4: hlt&#10;  0x00007fbe883ddec5: hlt&#10;  0x00007fbe883ddec6: hlt&#10;  0x00007fbe883ddec7: hlt&#10;  0x00007fbe883ddec8: hlt&#10;  0x00007fbe883ddec9: hlt&#10;  0x00007fbe883ddeca: hlt&#10;  0x00007fbe883ddecb: hlt&#10;  0x00007fbe883ddecc: hlt&#10;  0x00007fbe883ddecd: hlt&#10;  0x00007fbe883ddece: hlt&#10;  0x00007fbe883ddecf: hlt&#10;  0x00007fbe883dded0: hlt&#10;  0x00007fbe883dded1: hlt&#10;  0x00007fbe883dded2: hlt&#10;  0x00007fbe883dded3: hlt&#10;  0x00007fbe883dded4: hlt&#10;  0x00007fbe883dded5: hlt&#10;  0x00007fbe883dded6: hlt&#10;  0x00007fbe883dded7: hlt&#10;  0x00007fbe883dded8: hlt&#10;  0x00007fbe883dded9: hlt&#10;  0x00007fbe883ddeda: hlt&#10;  0x00007fbe883ddedb: hlt&#10;  0x00007fbe883ddedc: hlt&#10;  0x00007fbe883ddedd: hlt&#10;  0x00007fbe883ddede: hlt&#10;  0x00007fbe883ddedf: hlt&#10;[Stub Code]&#10;  0x00007fbe883ddee0: mov    $0x0,%rbx          ;   &#123;no_reloc&#125;&#10;  0x00007fbe883ddeea: jmpq   0x00007fbe883ddeea  ;   &#123;runtime_call&#125;&#10;[Exception Handler]&#10;  0x00007fbe883ddeef: jmpq   0x00007fbe883dc860  ;   &#123;runtime_call&#125;&#10;[Deopt Handler Code]&#10;  0x00007fbe883ddef4: callq  0x00007fbe883ddef9&#10;  0x00007fbe883ddef9: subq   $0x5,(%rsp)&#10;  0x00007fbe883ddefe: jmpq   0x00007fbe883b6c00  ;   &#123;runtime_call&#125;&#10;  0x00007fbe883ddf03: hlt&#10;  0x00007fbe883ddf04: hlt&#10;  0x00007fbe883ddf05: hlt&#10;  0x00007fbe883ddf06: hlt&#10;  0x00007fbe883ddf07: hlt&#10;flag cancel set to true</span><br></pre></td></tr></table></figure>
<p>带有volatile的版本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yuan@yuan-HP:~/learn$ jdk1.7.0_25/bin/java -XX:+UnlockDiagnosticVMOptions -XX:+PrintAssembly MemoryBarrierDemo&#10;Java HotSpot(TM) 64-Bit Server VM warning: PrintAssembly is enabled; turning on DebugNonSafepoints to gain additional output&#10;OS: Linux amd64&#10;JavaVersion: 1.7.0_25&#10;&#10;Loaded disassembler from /home/yuan/learn/jdk1.7.0_25/jre/lib/amd64/hsdis-amd64.so&#10;Decoding compiled method 0x00007fb865061890:&#10;Code:&#10;[Disassembling for mach=&#39;i386:x86-64&#39;]&#10;[Entry Point]&#10;[Verified Entry Point]&#10;[Constants]&#10;  # &#123;method&#125; &#39;access$000&#39; &#39;()Z&#39; in &#39;MemoryBarrierDemo&#39;&#10;  #           [sp+0x20]  (sp of caller)&#10;  0x00007fb8650619c0: sub    $0x18,%rsp&#10;  0x00007fb8650619c7: mov    %rbp,0x10(%rsp)    ;*synchronization entry&#10;                                                ; - MemoryBarrierDemo::access$000@-1 (line 1)&#10;  0x00007fb8650619cc: mov    $0xebcfc590,%r10   ;   &#123;oop(a &#39;java/lang/Class&#39; = &#39;MemoryBarrierDemo&#39;)&#125;&#10;  0x00007fb8650619d6: movzbl 0x70(%r10),%eax    ;*getstatic cancel&#10;                                                ; - MemoryBarrierDemo::access$000@0 (line 1)&#10;  0x00007fb8650619db: add    $0x10,%rsp&#10;  0x00007fb8650619df: pop    %rbp&#10;  0x00007fb8650619e0: test   %eax,0xb55e61a(%rip)        # 0x00007fb8705c0000&#10;                                                ;   &#123;poll_return&#125;&#10;  0x00007fb8650619e6: retq&#10;  0x00007fb8650619e7: hlt&#10;  0x00007fb8650619e8: hlt&#10;  0x00007fb8650619e9: hlt&#10;  0x00007fb8650619ea: hlt&#10;  0x00007fb8650619eb: hlt&#10;  0x00007fb8650619ec: hlt&#10;  0x00007fb8650619ed: hlt&#10;  0x00007fb8650619ee: hlt&#10;  0x00007fb8650619ef: hlt&#10;  0x00007fb8650619f0: hlt&#10;  0x00007fb8650619f1: hlt&#10;  0x00007fb8650619f2: hlt&#10;  0x00007fb8650619f3: hlt&#10;  0x00007fb8650619f4: hlt&#10;  0x00007fb8650619f5: hlt&#10;  0x00007fb8650619f6: hlt&#10;  0x00007fb8650619f7: hlt&#10;  0x00007fb8650619f8: hlt&#10;  0x00007fb8650619f9: hlt&#10;  0x00007fb8650619fa: hlt&#10;  0x00007fb8650619fb: hlt&#10;  0x00007fb8650619fc: hlt&#10;  0x00007fb8650619fd: hlt&#10;  0x00007fb8650619fe: hlt&#10;  0x00007fb8650619ff: hlt&#10;[Exception Handler]&#10;[Stub Code]&#10;  0x00007fb865061a00: jmpq   0x00007fb86505e860  ;   &#123;no_reloc&#125;&#10;[Deopt Handler Code]&#10;  0x00007fb865061a05: callq  0x00007fb865061a0a&#10;  0x00007fb865061a0a: subq   $0x5,(%rsp)&#10;  0x00007fb865061a0f: jmpq   0x00007fb865038c00  ;   &#123;runtime_call&#125;&#10;  0x00007fb865061a14: hlt&#10;  0x00007fb865061a15: hlt&#10;  0x00007fb865061a16: hlt&#10;  0x00007fb865061a17: hlt&#10;Decoding compiled method 0x00007fb86505fc90:&#10;Code:&#10;[Entry Point]&#10;[Verified Entry Point]&#10;[Constants]&#10;  # &#123;method&#125; &#39;run&#39; &#39;()V&#39; in &#39;MemoryBarrierDemo$1&#39;&#10;  0x00007fb86505fde0: callq  0x00007fb86f3c7370  ;   &#123;runtime_call&#125;&#10;  0x00007fb86505fde5: nopw   0x0(%rax,%rax,1)&#10;  0x00007fb86505fdf0: mov    %eax,-0x14000(%rsp)&#10;  0x00007fb86505fdf7: push   %rbp&#10;  0x00007fb86505fdf8: sub    $0x10,%rsp&#10;  0x00007fb86505fdfc: mov    (%rsi),%ebp&#10;  0x00007fb86505fdfe: mov    %rsi,%rdi&#10;  0x00007fb86505fe01: mov    $0x7fb86f454400,%r10&#10;  0x00007fb86505fe0b: callq  *%r10              ;*synchronization entry&#10;                                                ; - MemoryBarrierDemo::access$000@-1 (line 1)&#10;                                                ; - MemoryBarrierDemo$1::run@2 (line 10)&#10;  0x00007fb86505fe0e: mov    $0xebcfc590,%r10   ;   &#123;oop(a &#39;java/lang/Class&#39; = &#39;MemoryBarrierDemo&#39;)&#125;&#10;  0x00007fb86505fe18: movzbl 0x70(%r10),%r8d    ;*getstatic cancel&#10;                                                ; - MemoryBarrierDemo::access$000@0 (line 1)&#10;                                                ; - MemoryBarrierDemo$1::run@2 (line 10)&#10;  0x00007fb86505fe1d: test   %r8d,%r8d&#10;  0x00007fb86505fe20: jne    0x00007fb86505fe42  ;*ifne&#10;                                                ; - MemoryBarrierDemo$1::run@5 (line 10)&#10;  0x00007fb86505fe22: nopw   0x0(%rax,%rax,1)&#10;  0x00007fb86505fe2c: xchg   %ax,%ax            ;*iinc&#10;                                                ; - MemoryBarrierDemo$1::run@8 (line 11)&#10;  0x00007fb86505fe30: movzbl 0x70(%r10),%r11d   ;*getstatic cancel&#10;                                                ; - MemoryBarrierDemo::access$000@0 (line 1)&#10;                                                ; - MemoryBarrierDemo$1::run@2 (line 10)&#10;  0x00007fb86505fe35: inc    %ebp               ; OopMap&#123;r10=Oop off=87&#125;&#10;                                                ;*goto&#10;                                                ; - MemoryBarrierDemo$1::run@11 (line 11)&#10;  0x00007fb86505fe37: test   %eax,0xb5601c3(%rip)        # 0x00007fb8705c0000&#10;                                                ;*getstatic cancel&#10;                                                ; - MemoryBarrierDemo::access$000@0 (line 1)&#10;                                                ; - MemoryBarrierDemo$1::run@2 (line 10)&#10;                                                ;   &#123;poll&#125;&#10;  0x00007fb86505fe3d: test   %r11d,%r11d&#10;  0x00007fb86505fe40: je     0x00007fb86505fe30  ;*ifne&#10;                                                ; - MemoryBarrierDemo$1::run@5 (line 10)&#10;  0x00007fb86505fe42: mov    $0xebcb0d10,%r10   ;   &#123;oop(a &#39;java/lang/Class&#39; = &#39;java/lang/System&#39;)&#125;&#10;  0x00007fb86505fe4c: mov    0x74(%r10),%r10d   ;*getstatic out&#10;                                                ; - MemoryBarrierDemo$1::run@14 (line 13)&#10;  0x00007fb86505fe50: test   %r10d,%r10d&#10;  0x00007fb86505fe53: je     0x00007fb86505fe74  ;*invokevirtual println&#10;                                                ; - MemoryBarrierDemo$1::run@19 (line 13)&#10;  0x00007fb86505fe55: mov    %r10,%rsi          ;*getstatic out&#10;                                                ; - MemoryBarrierDemo$1::run@14 (line 13)&#10;  0x00007fb86505fe58: mov    $0xebd4b960,%rdx   ;   &#123;oop(&#34;Done!&#34;)&#125;&#10;  0x00007fb86505fe62: nop&#10;  0x00007fb86505fe63: callq  0x00007fb865037c60  ; OopMap&#123;off=136&#125;&#10;                                                ;*invokevirtual println&#10;                                                ; - MemoryBarrierDemo$1::run@19 (line 13)&#10;                                                ;   &#123;optimized virtual_call&#125;&#10;  0x00007fb86505fe68: add    $0x10,%rsp&#10;  0x00007fb86505fe6c: pop    %rbp&#10;  0x00007fb86505fe6d: test   %eax,0xb56018d(%rip)        # 0x00007fb8705c0000&#10;                                                ;   &#123;poll_return&#125;&#10;  0x00007fb86505fe73: retq&#10;  0x00007fb86505fe74: mov    $0xfffffff6,%esi&#10;  0x00007fb86505fe79: xchg   %ax,%ax&#10;  0x00007fb86505fe7b: callq  0x00007fb865039020  ; OopMap&#123;off=160&#125;&#10;                                                ;*invokevirtual println&#10;                                                ; - MemoryBarrierDemo$1::run@19 (line 13)&#10;                                                ;   &#123;runtime_call&#125;&#10;  0x00007fb86505fe80: callq  0x00007fb86f3c7370  ;*invokevirtual println&#10;                                                ; - MemoryBarrierDemo$1::run@19 (line 13)&#10;                                                ;   &#123;runtime_call&#125;&#10;  0x00007fb86505fe85: mov    %rax,%rsi&#10;  0x00007fb86505fe88: add    $0x10,%rsp&#10;  0x00007fb86505fe8c: pop    %rbp&#10;  0x00007fb86505fe8d: jmpq   0x00007fb8650615e0  ;   &#123;runtime_call&#125;&#10;  0x00007fb86505fe92: hlt&#10;  0x00007fb86505fe93: hlt&#10;  0x00007fb86505fe94: hlt&#10;  0x00007fb86505fe95: hlt&#10;  0x00007fb86505fe96: hlt&#10;  0x00007fb86505fe97: hlt&#10;  0x00007fb86505fe98: hlt&#10;  0x00007fb86505fe99: hlt&#10;  0x00007fb86505fe9a: hlt&#10;  0x00007fb86505fe9b: hlt&#10;  0x00007fb86505fe9c: hlt&#10;  0x00007fb86505fe9d: hlt&#10;  0x00007fb86505fe9e: hlt&#10;  0x00007fb86505fe9f: hlt&#10;[Stub Code]&#10;  0x00007fb86505fea0: mov    $0x0,%rbx          ;   &#123;no_reloc&#125;&#10;  0x00007fb86505feaa: jmpq   0x00007fb86505feaa  ;   &#123;runtime_call&#125;&#10;[Exception Handler]&#10;  0x00007fb86505feaf: jmpq   0x00007fb86505e860  ;   &#123;runtime_call&#125;&#10;[Deopt Handler Code]&#10;  0x00007fb86505feb4: callq  0x00007fb86505feb9&#10;  0x00007fb86505feb9: subq   $0x5,(%rsp)&#10;  0x00007fb86505febe: jmpq   0x00007fb865038c00  ;   &#123;runtime_call&#125;&#10;  0x00007fb86505fec3: hlt&#10;  0x00007fb86505fec4: hlt&#10;  0x00007fb86505fec5: hlt&#10;  0x00007fb86505fec6: hlt&#10;  0x00007fb86505fec7: hlt&#10;flag cancel set to true&#10;Done!&#10;yuan@yuan-HP:~/learn$</span><br></pre></td></tr></table></figure>
<p>现在我们分析一下。在没有volatile的版本中，循环递增部分的汇编代码很有趣，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x00007fbe883dde58: movzbl 0x70(%r10),%r11d&#10;0x00007fbe883dde5d: test   %r11d,%r11d&#10;0x00007fbe883dde60: jne    0x00007fbe883dde6c  ;*goto&#10;                                              ; - MemoryBarrierDemo$1::run@11 (line 11)&#10;0x00007fbe883dde62: inc    %ebx               ; OopMap&#123;off=68&#125;&#10;                                              ;*goto&#10;                                              ; - MemoryBarrierDemo$1::run@11 (line 11)&#10;0x00007fbe883dde64: test   %eax,0x9c6d196(%rip)        # 0x00007fbe9204b000&#10;                                              ;*goto&#10;                                              ; - MemoryBarrierDemo$1::run@11 (line 11)&#10;                                              ;   &#123;poll&#125;&#10;0x00007fbe883dde6a: jmp    0x00007fbe883dde62</span><br></pre></td></tr></table></figure>
<p>进入循环时检查过一次<code>cancel</code>，但是在后面却成了<code>jmp</code>无条件跳转，可想而知这肯定是编译器的“功劳”。在此笔者就先不深究这里所做的编译优化的原因了，只是简单的相信编译器已经获得了足够多的信息来判断<code>cancel</code>值在该线程是不变的。反过来推理，编译器的开发者肯定是对硬件层面的memory barrier有深入的理解才会做这个优化，这样也是本文想要探索的。</p>
<p>在带有volatile的版本中，循环递增部分的汇编代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x00007fb86505fe18: movzbl 0x70(%r10),%r8d    ;*getstatic cancel&#10;                                              ; - MemoryBarrierDemo::access$000@0 (line 1)&#10;                                              ; - MemoryBarrierDemo$1::run@2 (line 10)&#10;0x00007fb86505fe1d: test   %r8d,%r8d&#10;0x00007fb86505fe20: jne    0x00007fb86505fe42  ;*ifne&#10;                                              ; - MemoryBarrierDemo$1::run@5 (line 10)&#10;0x00007fb86505fe22: nopw   0x0(%rax,%rax,1)&#10;0x00007fb86505fe2c: xchg   %ax,%ax            ;*iinc&#10;                                              ; - MemoryBarrierDemo$1::run@8 (line 11)&#10;0x00007fb86505fe30: movzbl 0x70(%r10),%r11d   ;*getstatic cancel&#10;                                              ; - MemoryBarrierDemo::access$000@0 (line 1)&#10;                                              ; - MemoryBarrierDemo$1::run@2 (line 10)&#10;0x00007fb86505fe35: inc    %ebp               ; OopMap&#123;r10=Oop off=87&#125;&#10;                                              ;*goto&#10;                                              ; - MemoryBarrierDemo$1::run@11 (line 11)&#10;0x00007fb86505fe37: test   %eax,0xb5601c3(%rip)        # 0x00007fb8705c0000&#10;                                              ;*getstatic cancel&#10;                                              ; - MemoryBarrierDemo::access$000@0 (line 1)&#10;                                              ; - MemoryBarrierDemo$1::run@2 (line 10)&#10;                                              ;   &#123;poll&#125;&#10;0x00007fb86505fe3d: test   %r11d,%r11d&#10;0x00007fb86505fe40: je     0x00007fb86505fe30  ;*ifne&#10;                                              ; - MemoryBarrierDemo$1::run@5 (line 10)&#10;0x00007fb86505fe42: mov    $0xebcb0d10,%r10   ;   &#123;oop(a &#39;java/lang/Class&#39; = &#39;java/lang/System&#39;)&#125;</span><br></pre></td></tr></table></figure>
<p>该版本的主要不同是在于获取cacel前执行了<code>xchg   %ax,%ax</code>。</p>
<p>xchg是什么东东？查_Intel 64 and IA-32 Architectures Software Developer’s Manual Combined Volumes 3A, 3B, and 3C: System Programming Guide_：</p>
<p>8-3页：</p>
<blockquote>
<p>8.1.2 Bus Locking</p>
</blockquote>
<blockquote>
<p>Intel 64 and IA-32 processors provide a LOCK# signal that is asserted automatically during certain critical memory operations to lock the system bus or equivalent link. While this output signal is asserted, requests from other processors or bus agents for control of the bus are blocked. Software can specify other occasions when the LOCK semantics are to be followed by prepending the LOCK prefix to an instruction.</p>
</blockquote>
<blockquote>
<p>In the case of the Intel386, Intel486, and Pentium processors , explicitly locked instructions will result in the assertion of the LOCK# signal. It is the responsibility of the hardware designer to make the LOCK# signal available in system hardware to control memory accesses among processors.</p>
</blockquote>
<blockquote>
<p>For the P6 and more recent processor families, if the memory area being accessed is cached internally in the processor, the LOCK# signal is generally not asserted; instead, locking is only applied to the processor’s caches (see Section 8.1.4, “Effects of a LOCK Operation on Internal Processor Caches”).</p>
</blockquote>
<blockquote>
<p>8.1.2.1 Automatic Locking</p>
</blockquote>
<blockquote>
<p>The operations on which the processor automatically follows the LOCK semantics are as follows:</p>
</blockquote>
<blockquote>
<p>• When executing an XCHG instruction that references memory.</p>
</blockquote>
<p>8-15页：</p>
<blockquote>
<p>Synchronization mechanisms in multiple-processor systems may depend upon a strong memory-ordering model. Here, a program can use a locking instruction such as the XCHG instruction or the LOCK prefix to ensure that a read-modify-write operation on memory is carried out atomically. Locking operations typically operate like I/O operations in that they wait for all previous instructions to complete and for all buffered writes to drain to memory (see Section 8.1.2, “Bus Locking”).</p>
</blockquote>
<p>8-16页：</p>
<blockquote>
<p>Intel recommends that software written to run on Intel Core 2 Duo, Intel Atom, Intel Core Duo, Pentium 4, Intel Xeon, and P6 family processors assume the processor-ordering model or a weaker memory-ordering model. The Intel Core 2 Duo, Intel Atom, Intel Core Duo, Pentium 4, Intel Xeon, and P6 family processors do not implement a strong memory-ordering model, except when using the UC memory type. Despite the fact that Pentium 4, Intel Xeon, and P6 family processors support processor ordering, Intel does not guarantee that future processors will support this model. To make software portable to futu re processors, it is recommended that operating systems provide critical region and resource control constructs and API’s (application program interfaces) based on I/O, locking, and/or serializing instructions be used to synchronize access to shared areas of memory in multiple-processor systems. Also, software should not depend on processor ordering in situations where the system hardware does not support this memory-ordering model.</p>
</blockquote>
<p>读完之后，笔者大致了解了三点：</p>
<ol style="list-style-type: decimal">
<li><p>执行XCHG指令会自动跟随LOCK语义；</p></li>
<li><p>locking操作会等待前面所有的指令完成，并且将所有buffered writes写到内存；</p></li>
<li><p>memory-ordering model的强度是变化的，软件不能依赖processor ordering。这就解释了第一个版本中的编译优化，编译器从高级语言中得不到显式的信息（比如Locking和volatile），所以就默认使用processor-ordering model，编译器就会尽可能的优化性能；而在第二个版本中，有显式的volatile关键字，所以编译器就会加入XCHG指令，以实现strong memory-ordering model。</p></li>
</ol>
<p>等一下，好像哪里有问题。就算<code>xchg</code>触发了<code>LOCK</code>语义，但是缓存中的<code>cancel</code>并没有改变，所以也不会触发cache coherency protocol；就算<code>cancel</code>所在的cache line由于别的原因被修改了，而此前主线程没有对<code>cancel</code>进行修改的话，也是没有用呀。再从头开始想想这个逻辑，如果让笔者设计编译器，笔者应该会在<code>cancel = true;</code>这行之后加上LOCK语义。再回过头看看汇编代码，竟然找不到对应的代码！</p>
<p>经过笔者多次尝试，最后通过加入<code>-Xcomp</code>打印出了所需的信息，另外对Java代码也做了点儿改动。（笔者对此有蛮多疑惑，暂且存疑吧-_-）</p>
<p>修改后的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemoryBarrierDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> cancel = <span class="keyword">false</span>;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setCancel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                cancel = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">                <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                        <span class="annotation">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">                                <span class="keyword">while</span> (!cancel) &#123;</span><br><span class="line">                                        i++;</span><br><span class="line">                                &#125;</span><br><span class="line">                                System.out.println(<span class="string">"Done!"</span>);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                &#125;).start();</span><br><span class="line"></span><br><span class="line">                System.out.println(<span class="string">"OS: "</span> + System.getProperty(<span class="string">"os.name"</span>) + <span class="string">" "</span> + System.getProperty(<span class="string">"os.arch"</span>) + <span class="string">"\n"</span></span><br><span class="line">                                + <span class="string">"JavaVersion: "</span> + System.getProperty(<span class="string">"java.version"</span>) + <span class="string">"\n"</span>);</span><br><span class="line">                Thread.sleep(<span class="number">2048</span>);</span><br><span class="line">                <span class="comment">//cancel = true;</span></span><br><span class="line">                setCancel();</span><br><span class="line">                System.out.println(<span class="string">"flag cancel set to true"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>汇编代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yuan@yuan-HP:~/learn$ jdk1.7.0_25/bin/java -Xcomp  -XX:+UnlockDiagnosticVMOptions -XX:PrintAssemblyOptions=hsdis-print-bytes -XX:CompileCommand=print,MemoryBarrierDemo.* MemoryBarrierDemo&#10;CompilerOracle: print MemoryBarrierDemo.*&#10;Java HotSpot(TM) 64-Bit Server VM warning: printing of assembly code is enabled; turning on DebugNonSafepoints to gain additional output&#10;Compiled method (c2)     888  370             MemoryBarrierDemo::&#60;clinit&#62; (5 bytes)&#10; total in heap  [0x00007fbaec8ae2d0,0x00007fbaec8ae4a0] = 464&#10; relocation     [0x00007fbaec8ae3f0,0x00007fbaec8ae400] = 16&#10; main code      [0x00007fbaec8ae400,0x00007fbaec8ae440] = 64&#10; stub code      [0x00007fbaec8ae440,0x00007fbaec8ae458] = 24&#10; oops           [0x00007fbaec8ae458,0x00007fbaec8ae460] = 8&#10; scopes data    [0x00007fbaec8ae460,0x00007fbaec8ae468] = 8&#10; scopes pcs     [0x00007fbaec8ae468,0x00007fbaec8ae498] = 48&#10; dependencies   [0x00007fbaec8ae498,0x00007fbaec8ae4a0] = 8&#10;Loaded disassembler from /home/yuan/learn/jdk1.7.0_25/jre/lib/amd64/hsdis-amd64.so&#10;Decoding compiled method 0x00007fbaec8ae2d0:&#10;Code:&#10;[Disassembling for mach=&#39;i386:x86-64&#39;]&#10;[Entry Point]&#10;[Verified Entry Point]&#10;[Constants]&#10;  # &#123;method&#125; &#39;&#60;clinit&#62;&#39; &#39;()V&#39; in &#39;MemoryBarrierDemo&#39;&#10;  #           [sp+0x20]  (sp of caller)&#10;  0x00007fbaec8ae400: sub    $0x18,%rsp         ;...4881ec18 000000&#10;  0x00007fbaec8ae407: mov    %rbp,0x10(%rsp)    ;...48896c24 10&#10;  0x00007fbaec8ae40c: mov    $0xebd9deb8,%r10   ;...49bab8de d9eb00&#10;                                                ;...000000&#10;                                                ;   &#123;oop(a &#39;java/lang/Class&#39; = &#39;MemoryBarrierDemo&#39;)&#125;&#10;  0x00007fbaec8ae416: mov    %r12b,0x70(%r10)   ;...45886270&#10;  0x00007fbaec8ae41a: lock addl $0x0,(%rsp)     ;...f0830424 00&#10;                                                ;*putstatic cancel&#10;                                                ; - MemoryBarrierDemo::&#60;clinit&#62;@1 (line 3)&#10;  0x00007fbaec8ae41f: add    $0x10,%rsp         ;...4883c410&#10;  0x00007fbaec8ae423: pop    %rbp               ;...5d&#10;  0x00007fbaec8ae424: test   %eax,0x9c59bd6(%rip)        # 0x00007fbaf6508000&#10;                                                ;...8505d69b c509&#10;                                                ;   &#123;poll_return&#125;&#10;  0x00007fbaec8ae42a: retq                      ;...c3&#10;  0x00007fbaec8ae42b: hlt                       ;...f4&#10;  0x00007fbaec8ae42c: hlt                       ;...f4&#10;  0x00007fbaec8ae42d: hlt                       ;...f4&#10;  0x00007fbaec8ae42e: hlt                       ;...f4&#10;  0x00007fbaec8ae42f: hlt                       ;...f4&#10;  0x00007fbaec8ae430: hlt                       ;...f4&#10;  0x00007fbaec8ae431: hlt                       ;...f4&#10;  0x00007fbaec8ae432: hlt                       ;...f4&#10;  0x00007fbaec8ae433: hlt                       ;...f4&#10;  0x00007fbaec8ae434: hlt                       ;...f4&#10;  0x00007fbaec8ae435: hlt                       ;...f4&#10;  0x00007fbaec8ae436: hlt                       ;...f4&#10;  0x00007fbaec8ae437: hlt                       ;...f4&#10;  0x00007fbaec8ae438: hlt                       ;...f4&#10;  0x00007fbaec8ae439: hlt                       ;...f4&#10;  0x00007fbaec8ae43a: hlt                       ;...f4&#10;  0x00007fbaec8ae43b: hlt                       ;...f4&#10;  0x00007fbaec8ae43c: hlt                       ;...f4&#10;  0x00007fbaec8ae43d: hlt                       ;...f4&#10;  0x00007fbaec8ae43e: hlt                       ;...f4&#10;  0x00007fbaec8ae43f: hlt                       ;...f4&#10;[Exception Handler]&#10;[Stub Code]&#10;  0x00007fbaec8ae440: jmpq   0x00007fbaec80f860  ;...e91b14f6 ff&#10;                                                ;   &#123;no_reloc&#125;&#10;[Deopt Handler Code]&#10;  0x00007fbaec8ae445: callq  0x00007fbaec8ae44a  ;...e8000000 00&#10;  0x00007fbaec8ae44a: subq   $0x5,(%rsp)        ;...48832c24 05&#10;  0x00007fbaec8ae44f: jmpq   0x00007fbaec7eac00  ;...e9acc7f3 ff&#10;                                                ;   &#123;runtime_call&#125;&#10;  0x00007fbaec8ae454: hlt                       ;...f4&#10;  0x00007fbaec8ae455: hlt                       ;...f4&#10;  0x00007fbaec8ae456: hlt                       ;...f4&#10;  0x00007fbaec8ae457: hlt                       ;...f4&#10;OopMapSet contains 0 OopMaps&#10;&#10;Compiled method (c2)     893  371             MemoryBarrierDemo::main (100 bytes)&#10; total in heap  [0x00007fbaec8b10d0,0x00007fbaec8b12b0] = 480&#10; relocation     [0x00007fbaec8b11f0,0x00007fbaec8b1200] = 16&#10; main code      [0x00007fbaec8b1200,0x00007fbaec8b1220] = 32&#10; stub code      [0x00007fbaec8b1220,0x00007fbaec8b1238] = 24&#10; oops           [0x00007fbaec8b1238,0x00007fbaec8b1240] = 8&#10; scopes data    [0x00007fbaec8b1240,0x00007fbaec8b1258] = 24&#10; scopes pcs     [0x00007fbaec8b1258,0x00007fbaec8b12a8] = 80&#10; dependencies   [0x00007fbaec8b12a8,0x00007fbaec8b12b0] = 8&#10;Decoding compiled method 0x00007fbaec8b10d0:&#10;Code:&#10;[Entry Point]&#10;[Verified Entry Point]&#10;[Constants]&#10;  # &#123;method&#125; &#39;main&#39; &#39;([Ljava/lang/String;)V&#39; in &#39;MemoryBarrierDemo&#39;&#10;  # parm0:    rsi:rsi   = &#39;[Ljava/lang/String;&#39;&#10;  #           [sp+0x20]  (sp of caller)&#10;  0x00007fbaec8b1200: mov    %eax,-0x14000(%rsp)  ;...89842400 c0feff&#10;  0x00007fbaec8b1207: push   %rbp               ;...55&#10;  0x00007fbaec8b1208: sub    $0x10,%rsp         ;...4883ec10&#10;                                                ;*synchronization entry&#10;                                                ; - MemoryBarrierDemo::main@-1 (line 9)&#10;  0x00007fbaec8b120c: mov    $0x3,%esi          ;...be030000 00&#10;  0x00007fbaec8b1211: xchg   %ax,%ax            ;...6690&#10;  0x00007fbaec8b1213: callq  0x00007fbaec7eb020  ;...e8089ef3 ff&#10;                                                ; OopMap&#123;off=24&#125;&#10;                                                ;*new  ; - MemoryBarrierDemo::main@0 (line 9)&#10;                                                ;   &#123;runtime_call&#125;&#10;  0x00007fbaec8b1218: callq  0x00007fbaf530f370  ;...e853e1a5 08&#10;                                                ;*new  ; - MemoryBarrierDemo::main@0 (line 9)&#10;                                                ;   &#123;runtime_call&#125;&#10;  0x00007fbaec8b121d: hlt                       ;...f4&#10;  0x00007fbaec8b121e: hlt                       ;...f4&#10;  0x00007fbaec8b121f: hlt                       ;...f4&#10;[Exception Handler]&#10;[Stub Code]&#10;  0x00007fbaec8b1220: jmpq   0x00007fbaec80f860  ;...e93be6f5 ff&#10;                                                ;   &#123;no_reloc&#125;&#10;[Deopt Handler Code]&#10;  0x00007fbaec8b1225: callq  0x00007fbaec8b122a  ;...e8000000 00&#10;  0x00007fbaec8b122a: subq   $0x5,(%rsp)        ;...48832c24 05&#10;  0x00007fbaec8b122f: jmpq   0x00007fbaec7eac00  ;...e9cc99f3 ff&#10;                                                ;   &#123;runtime_call&#125;&#10;  0x00007fbaec8b1234: hlt                       ;...f4&#10;  0x00007fbaec8b1235: hlt                       ;...f4&#10;  0x00007fbaec8b1236: hlt                       ;...f4&#10;  0x00007fbaec8b1237: hlt                       ;...f4&#10;OopMapSet contains 1 OopMaps&#10;&#10;#0&#10;OopMap&#123;off=24&#125;&#10;Compiled method (c2)     994  398             MemoryBarrierDemo::access$000 (4 bytes)&#10; total in heap  [0x00007fbaec8b9390,0x00007fbaec8b9578] = 488&#10; relocation     [0x00007fbaec8b94b0,0x00007fbaec8b94c0] = 16&#10; main code      [0x00007fbaec8b94c0,0x00007fbaec8b9500] = 64&#10; stub code      [0x00007fbaec8b9500,0x00007fbaec8b9518] = 24&#10; oops           [0x00007fbaec8b9518,0x00007fbaec8b9520] = 8&#10; scopes data    [0x00007fbaec8b9520,0x00007fbaec8b9530] = 16&#10; scopes pcs     [0x00007fbaec8b9530,0x00007fbaec8b9570] = 64&#10; dependencies   [0x00007fbaec8b9570,0x00007fbaec8b9578] = 8&#10;Decoding compiled method 0x00007fbaec8b9390:&#10;Code:&#10;[Entry Point]&#10;[Verified Entry Point]&#10;[Constants]&#10;  # &#123;method&#125; &#39;access$000&#39; &#39;()Z&#39; in &#39;MemoryBarrierDemo&#39;&#10;  #           [sp+0x20]  (sp of caller)&#10;  0x00007fbaec8b94c0: sub    $0x18,%rsp         ;...4881ec18 000000&#10;  0x00007fbaec8b94c7: mov    %rbp,0x10(%rsp)    ;...48896c24 10&#10;                                                ;*synchronization entry&#10;                                                ; - MemoryBarrierDemo::access$000@-1 (line 1)&#10;  0x00007fbaec8b94cc: mov    $0xebd9deb8,%r10   ;...49bab8de d9eb00&#10;                                                ;...000000&#10;                                                ;   &#123;oop(a &#39;java/lang/Class&#39; = &#39;MemoryBarrierDemo&#39;)&#125;&#10;  0x00007fbaec8b94d6: movzbl 0x70(%r10),%eax    ;...410fb642 70&#10;                                                ;*getstatic cancel&#10;                                                ; - MemoryBarrierDemo::access$000@0 (line 1)&#10;  0x00007fbaec8b94db: add    $0x10,%rsp         ;...4883c410&#10;  0x00007fbaec8b94df: pop    %rbp               ;...5d&#10;  0x00007fbaec8b94e0: test   %eax,0x9c4eb1a(%rip)        # 0x00007fbaf6508000&#10;                                                ;...85051aeb c409&#10;                                                ;   &#123;poll_return&#125;&#10;  0x00007fbaec8b94e6: retq                      ;...c3&#10;  0x00007fbaec8b94e7: hlt                       ;...f4&#10;  0x00007fbaec8b94e8: hlt                       ;...f4&#10;  0x00007fbaec8b94e9: hlt                       ;...f4&#10;  0x00007fbaec8b94ea: hlt                       ;...f4&#10;  0x00007fbaec8b94eb: hlt                       ;...f4&#10;  0x00007fbaec8b94ec: hlt                       ;...f4&#10;  0x00007fbaec8b94ed: hlt                       ;...f4&#10;  0x00007fbaec8b94ee: hlt                       ;...f4&#10;  0x00007fbaec8b94ef: hlt                       ;...f4&#10;  0x00007fbaec8b94f0: hlt                       ;...f4&#10;  0x00007fbaec8b94f1: hlt                       ;...f4&#10;  0x00007fbaec8b94f2: hlt                       ;...f4&#10;  0x00007fbaec8b94f3: hlt                       ;...f4&#10;  0x00007fbaec8b94f4: hlt                       ;...f4&#10;  0x00007fbaec8b94f5: hlt                       ;...f4&#10;  0x00007fbaec8b94f6: hlt                       ;...f4&#10;  0x00007fbaec8b94f7: hlt                       ;...f4&#10;  0x00007fbaec8b94f8: hlt                       ;...f4&#10;  0x00007fbaec8b94f9: hlt                       ;...f4&#10;  0x00007fbaec8b94fa: hlt                       ;...f4&#10;  0x00007fbaec8b94fb: hlt                       ;...f4&#10;  0x00007fbaec8b94fc: hlt                       ;...f4&#10;  0x00007fbaec8b94fd: hlt                       ;...f4&#10;  0x00007fbaec8b94fe: hlt                       ;...f4&#10;  0x00007fbaec8b94ff: hlt                       ;...f4&#10;[Exception Handler]&#10;[Stub Code]&#10;  0x00007fbaec8b9500: jmpq   0x00007fbaec80f860  ;...e95b63f5 ff&#10;                                                ;   &#123;no_reloc&#125;&#10;[Deopt Handler Code]&#10;  0x00007fbaec8b9505: callq  0x00007fbaec8b950a  ;...e8000000 00&#10;  0x00007fbaec8b950a: subq   $0x5,(%rsp)        ;...48832c24 05&#10;  0x00007fbaec8b950f: jmpq   0x00007fbaec7eac00  ;...e9ec16f3 ff&#10;                                                ;   &#123;runtime_call&#125;&#10;  0x00007fbaec8b9514: hlt                       ;...f4&#10;  0x00007fbaec8b9515: hlt                       ;...f4&#10;  0x00007fbaec8b9516: hlt                       ;...f4&#10;  0x00007fbaec8b9517: hlt                       ;...f4&#10;OopMapSet contains 0 OopMaps&#10;&#10;OS: Linux amd64&#10;JavaVersion: 1.7.0_25&#10;&#10;Compiled method (c2)    3101  428             MemoryBarrierDemo::setCancel (5 bytes)&#10; total in heap  [0x00007fbaec896b90,0x00007fbaec896d60] = 464&#10; relocation     [0x00007fbaec896cb0,0x00007fbaec896cc0] = 16&#10; main code      [0x00007fbaec896cc0,0x00007fbaec896d00] = 64&#10; stub code      [0x00007fbaec896d00,0x00007fbaec896d18] = 24&#10; oops           [0x00007fbaec896d18,0x00007fbaec896d20] = 8&#10; scopes data    [0x00007fbaec896d20,0x00007fbaec896d28] = 8&#10; scopes pcs     [0x00007fbaec896d28,0x00007fbaec896d58] = 48&#10; dependencies   [0x00007fbaec896d58,0x00007fbaec896d60] = 8&#10;Decoding compiled method 0x00007fbaec896b90:&#10;Code:&#10;[Entry Point]&#10;[Verified Entry Point]&#10;[Constants]&#10;  # &#123;method&#125; &#39;setCancel&#39; &#39;()V&#39; in &#39;MemoryBarrierDemo&#39;&#10;  #           [sp+0x20]  (sp of caller)&#10;  0x00007fbaec896cc0: sub    $0x18,%rsp         ;...4881ec18 000000&#10;  0x00007fbaec896cc7: mov    %rbp,0x10(%rsp)    ;...48896c24 10&#10;  0x00007fbaec896ccc: mov    $0xebd9deb8,%r10   ;...49bab8de d9eb00&#10;                                                ;...000000&#10;                                                ;   &#123;oop(a &#39;java/lang/Class&#39; = &#39;MemoryBarrierDemo&#39;)&#125;&#10;  0x00007fbaec896cd6: movb   $0x1,0x70(%r10)    ;...41c64270 01&#10;  0x00007fbaec896cdb: lock addl $0x0,(%rsp)     ;...f0830424 00&#10;                                                ;*putstatic cancel&#10;                                                ; - MemoryBarrierDemo::setCancel@1 (line 5)&#10;  0x00007fbaec896ce0: add    $0x10,%rsp         ;...4883c410&#10;  0x00007fbaec896ce4: pop    %rbp               ;...5d&#10;  0x00007fbaec896ce5: test   %eax,0x9c71315(%rip)        # 0x00007fbaf6508000&#10;                                                ;...85051513 c709&#10;                                                ;   &#123;poll_return&#125;&#10;  0x00007fbaec896ceb: retq                      ;...c3&#10;  0x00007fbaec896cec: hlt                       ;...f4&#10;  0x00007fbaec896ced: hlt                       ;...f4&#10;  0x00007fbaec896cee: hlt                       ;...f4&#10;  0x00007fbaec896cef: hlt                       ;...f4&#10;  0x00007fbaec896cf0: hlt                       ;...f4&#10;  0x00007fbaec896cf1: hlt                       ;...f4&#10;  0x00007fbaec896cf2: hlt                       ;...f4&#10;  0x00007fbaec896cf3: hlt                       ;...f4&#10;  0x00007fbaec896cf4: hlt                       ;...f4&#10;  0x00007fbaec896cf5: hlt                       ;...f4&#10;  0x00007fbaec896cf6: hlt                       ;...f4&#10;  0x00007fbaec896cf7: hlt                       ;...f4&#10;  0x00007fbaec896cf8: hlt                       ;...f4&#10;  0x00007fbaec896cf9: hlt                       ;...f4&#10;  0x00007fbaec896cfa: hlt                       ;...f4&#10;  0x00007fbaec896cfb: hlt                       ;...f4&#10;  0x00007fbaec896cfc: hlt                       ;...f4&#10;  0x00007fbaec896cfd: hlt                       ;...f4&#10;  0x00007fbaec896cfe: hlt                       ;...f4&#10;  0x00007fbaec896cff: hlt                       ;...f4&#10;[Exception Handler]&#10;[Stub Code]&#10;  0x00007fbaec896d00: jmpq   0x00007fbaec80f860  ;...e95b8bf7 ff&#10;                                                ;   &#123;no_reloc&#125;&#10;[Deopt Handler Code]&#10;  0x00007fbaec896d05: callq  0x00007fbaec896d0a  ;...e8000000 00&#10;  0x00007fbaec896d0a: subq   $0x5,(%rsp)        ;...48832c24 05&#10;  0x00007fbaec896d0f: jmpq   0x00007fbaec7eac00  ;...e9ec3ef5 ff&#10;                                                ;   &#123;runtime_call&#125;&#10;  0x00007fbaec896d14: hlt                       ;...f4&#10;  0x00007fbaec896d15: hlt                       ;...f4&#10;  0x00007fbaec896d16: hlt                       ;...f4&#10;  0x00007fbaec896d17: hlt                       ;...f4&#10;OopMapSet contains 0 OopMaps&#10;&#10;flag cancel set to true&#10;Done!&#10;yuan@yuan-HP:~/learn$</span><br></pre></td></tr></table></figure>
<p>摘出我们所关心的部分：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x00007fbaec896ccc: mov    $0xebd9deb8,%r10   ;...49bab8de d9eb00&#10;                                              ;...000000&#10;                                              ;   &#123;oop(a &#39;java/lang/Class&#39; = &#39;MemoryBarrierDemo&#39;)&#125;&#10;0x00007fbaec896cd6: movb   $0x1,0x70(%r10)    ;...41c64270 01&#10;0x00007fbaec896cdb: lock addl $0x0,(%rsp)     ;...f0830424 00</span><br></pre></td></tr></table></figure>
<p>在<code>movb   $0x1,0x70(%r10)</code>将<code>cancel</code>设为<code>true</code>之后有一行带有LOCK语义的代码，这就与笔者推理的一致了^_^。</p>
<p>（在这里还有一个让笔者困惑的地方：对于没有volatile的版本，如果执行的时候加了<code>-Xcomp</code>，程序同样可以正常退出，程序行为与加了volatile的版本一致，但是汇编代码中到LOCK。笔者对于JIT完全不懂，所以也只能暂且存疑啦。）</p>
<p>再回过头来整理一下思路。在笔者提供的例子主要是因为没有遵守Java Memory Model，编译器为了性能而做出的优化造成程序无法终止。这其实也不是笔者想要看到的结果，但是通过读_Intel 64 and IA-32 Architectures Software Developer’s Manual Combined Volumes 3A, 3B, and 3C: System Programming Guide_解开了笔者心中的疑惑。</p>
<p>让笔者产生困惑的地方是buffer。</p>
<h2 id="buffer">Buffer</h2>
<p>笔者之前头脑中的CPU模型大概是这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+-------------------+&#10;| Memory Controller |&#10;+-------------------+&#10;        |&#10;+---------------------------------------------------------------+&#10;| L3                                                            |&#10;+---------------------------------------------------------------+&#10;        |                        |&#10;+-----------------+      +-----------------+&#10;| L1 L2           |      | L1 L2           |    ...&#10;+-----------------+      +-----------------+&#10;        |                        |&#10;+-----------------+      +-----------------+&#10;| Execution Units |      | Execution Units |    ...&#10;+-----------------+      +-----------------+</span><br></pre></td></tr></table></figure>
<p>从执行单元进入L1或L2 cache之后就是cache coherency protocol控制的“天下”了，其它的core肯定就会“看到”相应的改变，怎么还会“看不到”相应的改变呢？这就是让笔者一直困惑的地方。（关于cache coherency，请看<em>支撑处理器的技术</em>的第5.2节）</p>
<p>实际上现代的CPU在执行单元与L1、L2之间还存在Load Buffer、Store Buffer和WCBuffers。它们存在的原因？可想而知是为了弥补执行单元与缓存之间的速度差异，比如<a href="http://mechanical-sympathy.blogspot.com/2011/07/write-combining.html" target="_blank" rel="external">Write Combining</a>技术。对于这三个buffer，x86指令集中有三个细粒度的指令LFENCE、SFENCE和MFENCE控制，在前面所看到的LOCK等同于MFENCE。</p>
<p>在<em>Intel 64 and IA-32 Architectures Software Developer’s Manual Combined Volumes 3A, 3B, and 3C: System Programming Guide</em>的第8-16页：</p>
<blockquote>
<p>The SFENCE, LFENCE, and MFENCE instructions provide a performance-efficient way of ensuring load and store memory ordering between routines that produce weakly-ord ered results and routines that consume that data. The functions of these instructions are as follows:</p>
</blockquote>
<blockquote>
<ul>
<li>SFENCE — Serializes all store (write) operations that occu rred prior to the SFENCE instruction in the program instruction stream, but does not affect load operations.</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>LFENCE — Serializes all load (read) operations that occurred prior to the LFENCE instruction in the program instruction stream, but does not affect store operations.</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>MFENCE — Serializes all store and load operations that occurred prior to the MFENCE instruction in the program instruction stream.</li>
</ul>
</blockquote>
<p>关于这三个指令与Java语言的关系，请看<a href="http://mechanical-sympathy.blogspot.com/2011/07/memory-barriersfences.html" target="_blank" rel="external">Memory Barriers/Fences</a>。这篇文章中还提到了Out of Order的影响，所以本文就不再重复了。</p>
<h2 id="总结">总结</h2>
<ol style="list-style-type: decimal">
<li><p>CPU的“人生价值”就是尽可能的快！为此可以不择手段，比如Write Combining和Out of Order；但是它也提供了LOCK、XCHG、LFENCE、SFENCE、MFENCE等指令满足上层软件同步的需求。</p></li>
<li><p>同步要以牺牲性能为代价。JVM会尽可能优化性能，如果要实现必要的同步就得遵守Java Memory Model，在程序中显式的使用相关机制。</p></li>
<li><p>“Shared mutability is pure evil”（引自_Programming Concurrency on the JVM_）。如果不是legacy系统，笔者肯定优先考虑Actor-based Model。</p></li>
</ol>
	  
	</div>

	<div>
  	<center>
	<div class="pagination">
<ul class="pagination">
	 
				
    	<li class="prev"><a href="/2013/09/19/java_object_in_memory/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i>Prev</a></li>
  		

        <li><a href="/archives"><i class="fa fa-archive"></i>Archive</a></li>

		
		   <li class="next"><a href="/2013/08/07/disruptor5/" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a></li>         
        
	
</ul>
</div>

    </center>
	</div>
	
	<!-- comment -->
	
<section id="comment">
  <h2 class="title">Comments</h2>

  
</section>

	</div> <!-- col-md-9/col-md-12 -->
		
	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2013-08-10 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/concurrency/">concurrency<span>3</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
		

	<!-- toc -->
	<div class="meta-widget">
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

	</div>
		

</div><!-- row -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2015 Shichao Yuan
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a>. Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>.    
</p> </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 






<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>




<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</body>
   </html>
