<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Notes</title>
  <meta name="author" content="Shichao Yuan">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="Notes"/>

  
    <meta property="og:image" content="undefined"/>
  

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  



</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">Notes</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 <div class="page-header">
  <h1>Notes</h1>
</div>

<div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">
      <i class="fa fa-heart"></i>
      Stay Hungry, Stay Foolish.
</div>    
		<div id="top_search"></div>
		<div class="mypage">
		
		<!-- title and entry -->
		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-11-03 </div>
			<div class="article-title"><a href="/2015/11/03/password-strengths-evaluation-pcfg/" >Password Strengths Evaluation 2 (PCFG)</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		
		<!-- <h2 id="section">1</h2>
<p>上一篇谈了<a href="https://github.com/dropbox/zxcvbn" target="_blank" rel="external">zxcvbn</a>这个密码强度评估器：</p>
<ol style="list-style-type: decimal">
<li>预先设定密码的模式，比如l33t、键盘连续字符、连续重复字符、日期、字典等；</li>
<li>然后让待测密码匹配可能的模式；</li>
<li>计算entropy最小的模式串，最后估算破解时间。</li>
</ol>
<p>这里有几个问题：</p>
<ol style="list-style-type: decimal">
<li>为什么要预先设定这些模式？而不是其他的模式？</li>
<li>这些模式计算的entropy有效么？</li>
</ol>
<p>要回答这些问题，我们先回到zxcvbn针对的攻击者的角度：</p>
<ol style="list-style-type: decimal">
<li>构建字典，设想混淆密码的模式；</li>
<li>基于字典根据预先设定的模式猜测密码。</li>
</ol>
<p>可见如果攻防双方构建的字典、设定的模式差不多的话，那么这种评估方法是有效的，而且现实情况中这个假设基本上是成立。谈到密码破解，能想到的可能只有<a href="http://www.openwall.com/john/" target="_blank" rel="external">John the Ripper</a>。</p>
<p>在更短的时间内破解出更多的密码，无论在利益上还是荣誉上都是有巨大的驱动的，所以有些聪明的脑袋想出了另外一条思路——机器学习。比较有代表性的是Matt Weir, Sudhir Aggarwal, Breno de Medeiros, Bill Glodek在2009年提出的<a href="http://ieeexplore.ieee.org/xpl/articleDetails.jsp?arnumber=5207658" target="_blank" rel="external">《Password Cracking Using Probabilistic Context-Free Grammars》</a>，文章中给出的实验结果显示PCFG可以比John the Ripper多破解28%到129%的密码。</p>
<p>面对新型的攻击方式，防御的方法也得进行改变，基于PCFG如何做密码强度评估呢？Shiva Houshmand和Sudhir Aggarwal于2012年发表的<a href="http://dl.acm.org/citation.cfm?doid=2420950.2420966" target="_blank" rel="external">《Building Better Passwords using Probabilistic Techniques》</a>给出了一个方案。</p>
<h2 id="section-1">2</h2>
<p>什么是PCFG？</p>
<p>其中的Context-Free Grammar应该都很熟悉，<a href="http://docs.oracle.com/javase/specs/jls/se8/html/index.html" target="_blank" rel="external">JLS</a>就是用此描述程序的语法。可以将其理解为一系列的匹配规则，从左边匹配右边，最终匹配到终止字符，并且每次匹配不依赖上一次。加上Probabilistic，实际上就是为每次规则匹配赋予一个概率，比如：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="label">IntegerLiteral</span>:</span><br><span class="line">  DecimalIntegerLiteral   <span class="number">0</span>.<span class="number">2</span></span><br><span class="line">  HexIntegerLiteral       <span class="number">0</span>.<span class="number">3</span></span><br><span class="line">  OctalIntegerLiteral     <span class="number">0</span>.<span class="number">1</span></span><br><span class="line">  <span class="keyword">BinaryIntegerLiteral </span>   <span class="number">0</span>.<span class="number">4</span></span><br></pre></td></tr></table></figure>
<p>因为每次匹配是独立的，所以可以将匹配过程的概率值乘起来，如果规则附加的概率表示出现频率，那么最终的概率可以估算该语句出现频率。</p>
<p>PCFG传统的应用领域是自然语言处理，用于选择最合适的解析语法树。如果将密码理解为一种语言，自然而然就可以将PCFG迁移过来。通过泄露的密码库，训练PCFG模型，有了这个模型，就可以按照概率高低生成攻击的密码，同样的也可以用这个概率值表示密码强度。</p>
<h2 id="section-2">3</h2>
<p>如何定义密码的“语言”结构呢？</p>
<p>首先将字符串划分为三类：</p>
<table>
<thead>
<tr class="header">
<th align="left">Data Type</th>
<th align="left">Symbols</th>
<th align="left">Examples</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Alpha String</td>
<td align="left">abcdefghijklmnopqrstuvwxyzäö</td>
<td align="left">cat</td>
</tr>
<tr class="even">
<td align="left">Digit String</td>
<td align="left">0123456789</td>
<td align="left">432</td>
</tr>
<tr class="odd">
<td align="left">Special String</td>
<td align="left">!@#$%^&amp;*()-_=+[]{};’:”,./&lt;&gt;?|!!|</td>
</tr>
</tbody>
</table>
<p>这里用<strong>L</strong>表示Alpha，<strong>D</strong>表示Digit，<strong>S</strong>表示Special，那么就可以这样描述语法规则：</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="label">S:</span></span><br><span class="line">  D1L3S2D1      <span class="number">0.75</span></span><br><span class="line">  L3D1S1        <span class="number">0.25</span></span><br><span class="line"></span><br><span class="line"><span class="label">D1:</span></span><br><span class="line">  <span class="number">4</span>             <span class="number">0.6</span></span><br><span class="line">  <span class="number">5</span>             <span class="number">0.2</span></span><br><span class="line">  <span class="number">6</span>             <span class="number">0.2</span></span><br><span class="line"></span><br><span class="line"><span class="label">S1:</span></span><br><span class="line">  !             <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line"><span class="label">S2:</span></span><br><span class="line">  %%            <span class="number">0.9</span></span><br><span class="line">  ^$            <span class="number">0.1</span></span><br><span class="line"></span><br><span class="line"><span class="label">L3:</span>           <span class="number">0.2</span></span><br></pre></td></tr></table></figure>
<p>其中L3D1S1称为base structure，也就是两个Alpha、一个Digit、一个Special，对于Digit和Special直接匹配字符串，而Alpha比较特殊，只需要匹配长度。</p>
<p>如何使用PCFG模型计算密码的概率呢？</p>
<p>举个例子，<code>abc6!</code>按照上述规则计算概率为<code>0.25*0.2*0.2*1.0=0.01</code>。</p>
<p>那么如何训练这个模型呢？</p>
<p>已有大量的泄露密码数据，首先解析base structure，统计每种structure出现的频率做为概率；对于Digit和Special，针对不同的长度分别统计出现频率做为概率；而Alpha长度的规则比较特殊，通常来说训练集的数据没有代表性，这里可以通过统计字典数据计算这个概率，常用的字典可以从<a href="http://www.outpost9.com/files/WordLists.html" target="_blank" rel="external">Word lists…</a>这里找。</p>
<p>对于Alpha这里可以进一步优化，将大小写统计进去：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">L3</span>:           0<span class="class">.2</span></span><br><span class="line">  <span class="tag">ULL</span>           0<span class="class">.3</span></span><br><span class="line">  <span class="tag">LLL</span>           0<span class="class">.6</span></span><br><span class="line">  <span class="tag">LUL</span>           0<span class="class">.1</span></span><br></pre></td></tr></table></figure>
<p><strong>U</strong>表示大写，<strong>L</strong>表示小写，这个概率可以从密码数据中统计出来。</p>
<p>对于攻击者来说，模型训练到此已经完成了，但是对于密码强度评估，还差一步。设想一下，一个待评估的新密码，当前的模型很可能没有覆盖其对应的结构，那么此时如何评估呢？所以我们需要对训练模型进行<a href="http://doc.utwente.nl/85240/1/smoothing.pdf" target="_blank" rel="external">probability smoothing</a>，同时也解决了模型过拟合的问题，在我们的实现中使用了Laplace smoothing。</p>
<h2 id="section-3">4</h2>
<p>如何理解最后算出的概率呢？如果可以转换成上一篇提到guessing entropy就更直观了。</p>
<p>James L. Massey在<a href="http://ieeexplore.ieee.org/xpl/abstractAuthors.jsp?arnumber=394764" target="_blank" rel="external">《Guessing and Entropy》</a>中提出了一个由Shannon entropy推导guessing entropy下限的公式：</p>
<p><span class="math display">\[ G(X) \geq \frac{2^{H(X)}}{4}+1  \]</span></p>
<p>那么如果计算Shannon entropy呢？</p>
<p><span class="math display">\[
H(G) = H(B,R) = H(B) + H(B|R) = H(B) + \sum\nolimits_{i}[H(X_{i_1})+H(X_{i_2})+...+H(X_{i_k})]
\]</span></p>
<p>上述公式中B表示base structure，R表示各种匹配规则。</p>
<h2 id="section-4">5</h2>
<p>如何设定密码强度的阈值呢？</p>
<p>根据破解时间设定阈值，比如小于12小时为弱，大于15天为强，估算破解时间有两个思路：</p>
<ol style="list-style-type: decimal">
<li>由guessing entropy估算</li>
</ol>
<ul>
<li>具体方法与zxcvbn类似。</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>用guessing number估算</li>
</ol>
<ul>
<li>具体来说就是使用当前模型生成按照概率高低排序的猜测密码，每个密码累加上一个计算bcrypt/scrypt/PBKDF2的时间，然后就可以拟合出一条概率与耗时的曲线。</li>
</ul>
<h2 id="section-5">6</h2>
<p>将密码理解为自然语言可以说为密码强度评估（密码破解）领域打开了一扇窗，而且窗外有各种成熟的工具可以使用，比如说Markov模型。</p>
<p>还有哪些玩法呢？我们下一篇再谈。</p>
 -->
	
	</div>
  <a type="button" href="/2015/11/03/password-strengths-evaluation-pcfg/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-11-01 </div>
			<div class="article-title"><a href="/2015/11/01/weekly/" >Weekly 2015-11-01</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		
		<!-- <h3 id="理解矩阵">理解矩阵</h3>
<ol style="list-style-type: decimal">
<li><a href="http://blog.csdn.net/myan/article/details/647511" target="_blank" rel="external">理解矩阵（一）</a></li>
<li><a href="http://blog.csdn.net/myan/article/details/649018" target="_blank" rel="external">理解矩阵（二）</a></li>
<li><a href="http://blog.csdn.net/myan/article/details/1865397" target="_blank" rel="external">理解矩阵（三）</a></li>
</ol>
 -->
	
	</div>
  <a type="button" href="/2015/11/01/weekly/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-10-25 </div>
			<div class="article-title"><a href="/2015/10/25/weekly/" >Weekly 2015-10-25</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		
		<!-- <h3 id="how-to-write-a-git-commit-message"><a href="http://chris.beams.io/posts/git-commit/" target="_blank" rel="external">How to Write a Git Commit Message</a></h3>
<ol style="list-style-type: decimal">
<li>Separate subject from body with a blank line</li>
<li>Limit the subject line to 50 characters</li>
<li>Capitalize the subject line</li>
<li>Do not end the subject line with a period</li>
<li>Use the imperative mood in the subject line</li>
<li>Wrap the body at 72 characters</li>
<li>Use the body to explain <em>what</em> and <em>why</em> vs. <em>how</em></li>
</ol>
<h3 id="hystrix"><a href="https://github.com/Netflix/Hystrix" target="_blank" rel="external">Hystrix</a></h3>
<ol style="list-style-type: decimal">
<li>实现了<a href="http://martinfowler.com/bliki/CircuitBreaker.html" target="_blank" rel="external">Circuit Breaker Pattern</a></li>
<li>Request Cache</li>
<li>Request Collapsing</li>
</ol>
 -->
	
	</div>
  <a type="button" href="/2015/10/25/weekly/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-09-22 </div>
			<div class="article-title"><a href="/2015/09/22/password-strengths-evaluation-entropy/" >Password Strengths Evaluation 1 (Entropy)</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		
		<!-- <h2 id="section">1</h2>
<p>密码应该说是最普遍的身份认证的方式，对其的攻击也有很多种，比如：暴力破解、基于字典、甚至可以通过用户信息猜测、撞库，近年来又出现了基于机器学习的方法猜测密码的黑科技。</p>
<p>所以就有一系列问题，哪种密码对上述攻击的抵抗性更高？如何评估密码的强度？如何引导用户选择高强度而且容易记忆的密码。</p>
<p>关于这个几个问题，最近也是在边学边做，所以顺便做一下笔记，这篇就谈一下目前使用最广泛的密码强度评估方法——Entropy。</p>
<h2 id="section-1">2</h2>
<p>关于Entropy，Claude Shannon是这样解释的：</p>
<blockquote>
<p>The entropy is a statistical parameter which measures in a certain sense, how much information is produced on the average for each letter of a text in the language. If the language is translated into binary digits (0 or 1) in the most efficient way, the entropy H is the average number of binary digits required per letter of the original language.</p>
</blockquote>
<p>形式化为：</p>
<p><span class="math display">\[ H(X)=-\sum\limits_{x}P(X=x)\log_{2}P(X=x) \]</span></p>
<p>将自然语言中的entropy的概念迁移到密码中来，该值表征的就是密码的不确定程度，不确定程度越高，攻击者“猜”到密码的可能性越低。</p>
<p>首先假设密码是随机生成的，长度固定为<em>l</em>，可选字符集大小为<em>b</em>，那么此时</p>
<p><span class="math display">\[ H=log_{2}(b^{l}) \]</span></p>
<p>entropy的值是最高的，也就是说该密码库理论上是最安全的，但是此时也就没有可用性了，因为用户根本记不住随机密码（如果没有辅助手段）。</p>
<p>现实中的密码库远远不是随机的，Mark Burnett曾经搜集了6百万个密码，他发现其中有大量的重复密码，出现概率最高的1000个密码占总量的91%左右，而且很多密码符合一定的模式，比如qwerty、123456，或者再进行简单的l33t替换。</p>
<h2 id="section-2">3</h2>
<p>对于现实中的密码不能仅仅用<em>l</em>和<em>b</em>来计算entropy（当然这两个值对entropy贡献最大），那么如何基于entropy计算未知密码的强度呢？</p>
<p>dropbox开源了一个基于entropy的密码强度评估的类库——<a href="https://github.com/dropbox/zxcvbn" target="_blank" rel="external">zxcvbn</a>，我们看一下她是如何实现的。</p>
<p>首先用一下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10140;  zxcvbn git:(master) &#10007; node&#10;&#62; var zxcvbn = require(&#39;./dist/zxcvbn.js&#39;)&#10;undefined&#10;&#62; zxcvbn(&#39;Yu@n1989shiChao&#39;)&#10;&#123; password: &#39;Yu@n1989shiChao&#39;,&#10;  entropy: 41.911,&#10;  match_sequence:&#10;   [ &#123; pattern: &#39;dictionary&#39;,&#10;       i: 0,&#10;       j: 3,&#10;       token: &#39;Yu@n&#39;,&#10;       matched_word: &#39;yuan&#39;,&#10;       rank: 1237,&#10;       dictionary_name: &#39;passwords&#39;,&#10;       reversed: false,&#10;       l33t: true,&#10;       sub: [Object],&#10;       sub_display: &#39;@ -&#62; a&#39;,&#10;       base_entropy: 10.27262978497637,&#10;       uppercase_entropy: 1,&#10;       reversed_entropy: 0,&#10;       l33t_entropy: 1,&#10;       entropy: 12.27262978497637 &#125;,&#10;     &#123; pattern: &#39;regex&#39;,&#10;       token: &#39;1989&#39;,&#10;       i: 4,&#10;       j: 7,&#10;       regex_name: &#39;recent_year&#39;,&#10;       regex_match: [Object],&#10;       entropy: 4.321928094887363 &#125;,&#10;     &#123; pattern: &#39;regex&#39;,&#10;       token: &#39;shi&#39;,&#10;       i: 8,&#10;       j: 10,&#10;       regex_name: &#39;alpha_lower&#39;,&#10;       regex_match: [Object],&#10;       entropy: 14.101319154423278 &#125;,&#10;     &#123; pattern: &#39;dictionary&#39;,&#10;       i: 11,&#10;       j: 14,&#10;       token: &#39;Chao&#39;,&#10;       matched_word: &#39;chao&#39;,&#10;       rank: 1189,&#10;       dictionary_name: &#39;passwords&#39;,&#10;       reversed: false,&#10;       base_entropy: 10.215532999745657,&#10;       uppercase_entropy: 1,&#10;       reversed_entropy: 0,&#10;       l33t_entropy: 0,&#10;       entropy: 11.215532999745657 &#125; ],&#10;  crack_time: 206805262.144,&#10;  crack_time_display: &#39;6 years&#39;,&#10;  score: 4,&#10;  calc_time: 13 &#125;&#10;&#62;</span><br></pre></td></tr></table></figure>
<p>返回结果的字段的含义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">password &#23494;&#30721;&#10;entropy &#10;match_sequence &#23494;&#30721;&#21305;&#37197;&#21040;&#30340;&#27169;&#24335;&#10;crack_time &#20272;&#31639;&#30340;&#30772;&#35299;&#26102;&#38388;&#65292;&#26681;&#25454;entropy&#35745;&#31639;&#10;crack_time_display&#10;score &#26681;&#25454;crack_time&#26144;&#23556;&#30340;&#20998;&#20540;&#10;calc_time &#35745;&#31639;&#32791;&#26102;</span><br></pre></td></tr></table></figure>
<p>实际上zxcvbn累加了匹配到的模式的entropy值来评估密码强度，因为攻击者可以通过构建的字典和一些模式减小“猜”的范围。</p>
<p><strong>这种从攻击者的角度评估密码强度的思路是很可取的。</strong></p>
<p>抛开细枝末节看一下主流程：</p>
<figure class="highlight coffee"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 对输入的密码进行模式匹配，也就是结果中的match_sequence</span></span><br><span class="line">matches = matching.omnimatch password</span><br><span class="line"><span class="comment"># 计算各种entropy</span></span><br><span class="line">result = scoring.minimum_entropy_match_sequence password, matches</span><br></pre></td></tr></table></figure>
<p>zxcvbn考虑到的模式还是挺多的：</p>
<figure class="highlight coffee"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="property">@dictionary_match</span> <span class="comment">#基于字典，也就是查看密码的子串是否出现在字典中，以及在字典中的位置</span></span><br><span class="line">  <span class="attribute">passwords</span>:    build_ranked_dict frequency_lists.passwords <span class="comment">#常见的密码，概率降序</span></span><br><span class="line">  <span class="attribute">english</span>:      build_ranked_dict frequency_lists.english</span><br><span class="line">  <span class="attribute">surnames</span>:     build_ranked_dict frequency_lists.surnames</span><br><span class="line">  <span class="attribute">male_names</span>:   build_ranked_dict frequency_lists.male_names</span><br><span class="line">  <span class="attribute">female_names</span>: build_ranked_dict frequency_lists.female_names</span><br><span class="line"><span class="property">@reverse_dictionary_match</span> <span class="comment">#翻转密码字符串</span></span><br><span class="line"><span class="property">@l33t_match</span> <span class="comment">#l33t逆回去之后再进行dictionary_match</span></span><br><span class="line"><span class="property">@spatial_match</span> <span class="comment">#qwerty这类键盘连续的字符串</span></span><br><span class="line"><span class="property">@repeat_match</span> <span class="comment">#aaa这类连续的串</span></span><br><span class="line"><span class="property">@sequence_match</span> <span class="comment">#abcd这类连续的串</span></span><br><span class="line"><span class="property">@regex_match</span> <span class="comment">#匹配连续的符号、数字、大写、小写 （3个以上）</span></span><br><span class="line"><span class="property">@date_match</span> <span class="comment">#匹配日期</span></span><br></pre></td></tr></table></figure>
<p>得出一个匹配列表，然后按照i和j排个序，在列表中，ij区间是有重叠的，所以首先算出一个不重叠的子列表，并且要求entropy最小，这个过程可以理解为找最容易攻击的一组模式，所以就可以用这个最小的entropy做为密码强度的评估值。</p>
<figure class="highlight coffee"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">minimum_entropy_match_sequence</span>: <span class="function"><span class="params">(password, matches)</span> -&gt;</span></span><br><span class="line">  <span class="comment"># 计算暴力破解的基数，也就是计算entropy公式中的(b**l)</span></span><br><span class="line">  bruteforce_cardinality = <span class="property">@calc_bruteforce_cardinality</span> password <span class="comment"># e.g. 26 for lowercase</span></span><br><span class="line">  <span class="comment"># 保存到位置k的最小entropy，就是个动态规划嘛</span></span><br><span class="line">  up_to_k = []      <span class="comment"># minimum entropy up to k.</span></span><br><span class="line">  <span class="comment"># for the optimal seq of matches up to k, backpointers holds the final match (match.j == k).</span></span><br><span class="line">  <span class="comment"># null means the sequence ends w/ a brute-force character.</span></span><br><span class="line">  backpointers = []</span><br><span class="line">  <span class="keyword">for</span> k <span class="keyword">in</span> [<span class="number">0.</span>..password.length]</span><br><span class="line">    <span class="comment"># starting scenario to try and beat:</span></span><br><span class="line">    <span class="comment"># adding a brute-force character to the minimum entropy sequence at k-1.</span></span><br><span class="line">    up_to_k[k] = (up_to_k[k-<span class="number">1</span>] <span class="keyword">or</span> <span class="number">0</span>) + <span class="property">@lg</span> bruteforce_cardinality</span><br><span class="line">    backpointers[k] = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">for</span> match <span class="keyword">in</span> matches <span class="keyword">when</span> match.j == k</span><br><span class="line">      [i, j] = [match.i, match.j]</span><br><span class="line">      <span class="comment"># see if best entropy up to i-1 + entropy of this match is less than current minimum at j.</span></span><br><span class="line">      <span class="comment"># 在calc_entropy中，entropy的计算方法因“匹配类型”而异</span></span><br><span class="line">      candidate_entropy = (up_to_k[i-<span class="number">1</span>] <span class="keyword">or</span> <span class="number">0</span>) + <span class="property">@calc_entropy</span>(match)</span><br><span class="line">      <span class="keyword">if</span> candidate_entropy &lt; up_to_k[j]</span><br><span class="line">        up_to_k[j] = candidate_entropy</span><br><span class="line">        backpointers[j] = match</span><br><span class="line"></span><br><span class="line">  <span class="comment"># walk backwards and decode the best sequence</span></span><br><span class="line">  match_sequence = []</span><br><span class="line">  k = password.length - <span class="number">1</span></span><br><span class="line">  <span class="keyword">while</span> k &gt;= <span class="number">0</span></span><br><span class="line">    match = backpointers[k]</span><br><span class="line">    <span class="keyword">if</span> match</span><br><span class="line">      match_sequence.push match</span><br><span class="line">      k = match.i - <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      k -= <span class="number">1</span></span><br><span class="line">  match_sequence.reverse()</span><br><span class="line">  <span class="comment">#match_sequence就是不重叠的匹配列表，但是中间可能有没有覆盖的字符串</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># fill in the blanks between pattern matches with bruteforce "matches"</span></span><br><span class="line">  <span class="comment"># that way the match sequence fully covers the password:</span></span><br><span class="line">  <span class="comment"># match1.j == match2.i - 1 for every adjacent match1, match2.</span></span><br><span class="line"><span class="function">  <span class="title">make_bruteforce_match</span> = <span class="params">(i, j)</span> =&gt;</span></span><br><span class="line">    <span class="attribute">pattern</span>: <span class="string">'bruteforce'</span></span><br><span class="line">    <span class="attribute">i</span>: i</span><br><span class="line">    <span class="attribute">j</span>: j</span><br><span class="line">    <span class="attribute">token</span>: password[i..j]</span><br><span class="line">    <span class="attribute">entropy</span>: <span class="property">@lg</span> Math.pow(bruteforce_cardinality, j - i + <span class="number">1</span>)</span><br><span class="line">    <span class="attribute">cardinality</span>: bruteforce_cardinality</span><br><span class="line">  <span class="comment"># 使用bruteforce计算其中没有覆盖到的字符的entropy</span></span><br><span class="line">  k = <span class="number">0</span></span><br><span class="line">  match_sequence_copy = []</span><br><span class="line">  <span class="keyword">for</span> match <span class="keyword">in</span> match_sequence</span><br><span class="line">    [i, j] = [match.i, match.j]</span><br><span class="line">    <span class="keyword">if</span> i - k &gt; <span class="number">0</span></span><br><span class="line">      match_sequence_copy.push make_bruteforce_match(k, i - <span class="number">1</span>)</span><br><span class="line">    k = j + <span class="number">1</span></span><br><span class="line">    match_sequence_copy.push match</span><br><span class="line">  <span class="keyword">if</span> k &lt; password.length</span><br><span class="line">    match_sequence_copy.push make_bruteforce_match(k, password.length - <span class="number">1</span>)</span><br><span class="line">  match_sequence = match_sequence_copy</span><br><span class="line"></span><br><span class="line">  min_entropy = up_to_k[password.length - <span class="number">1</span>] <span class="keyword">or</span> <span class="number">0</span>  <span class="comment"># or 0 corner case is for an empty password ''</span></span><br><span class="line">  crack_time = <span class="property">@entropy_to_crack_time</span> min_entropy</span><br><span class="line"></span><br><span class="line">  <span class="comment"># final result object</span></span><br><span class="line">  <span class="attribute">password</span>: password</span><br><span class="line">  <span class="attribute">entropy</span>: <span class="property">@round_to_x_digits</span>(min_entropy, <span class="number">3</span>)</span><br><span class="line">  <span class="attribute">match_sequence</span>: match_sequence</span><br><span class="line">  <span class="attribute">crack_time</span>: <span class="property">@round_to_x_digits</span>(crack_time, <span class="number">3</span>)</span><br><span class="line">  <span class="attribute">crack_time_display</span>: <span class="property">@display_time</span> crack_time</span><br><span class="line">  <span class="attribute">score</span>: <span class="property">@crack_time_to_score</span> crack_time</span><br></pre></td></tr></table></figure>
<p>下面再看一下不同的匹配计算entropy的方式：</p>
<figure class="highlight coffee"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">calc_entropy</span>: <span class="function"><span class="params">(match)</span> -&gt;</span></span><br><span class="line">  <span class="keyword">return</span> match.entropy <span class="keyword">if</span> match.entropy? <span class="comment"># a match's entropy doesn't change. cache it.</span></span><br><span class="line">  entropy_functions =</span><br><span class="line">    <span class="attribute">dictionary</span>: <span class="property">@dictionary_entropy</span></span><br><span class="line">    <span class="attribute">spatial</span>:    <span class="property">@spatial_entropy</span></span><br><span class="line">    <span class="attribute">repeat</span>:     <span class="property">@repeat_entropy</span></span><br><span class="line">    <span class="attribute">sequence</span>:   <span class="property">@sequence_entropy</span></span><br><span class="line">    <span class="attribute">regex</span>:      <span class="property">@regex_entropy</span></span><br><span class="line">    <span class="attribute">date</span>:       <span class="property">@date_entropy</span></span><br><span class="line">  match.entropy = entropy_functions[match.pattern].call <span class="keyword">this</span>, match</span><br><span class="line">  </span><br><span class="line"><span class="attribute">dictionary_entropy</span>: <span class="function"><span class="params">(match)</span> -&gt;</span></span><br><span class="line">  <span class="comment">## 依赖于字典中字段的排位</span></span><br><span class="line">  match.base_entropy = <span class="property">@lg</span> match.rank <span class="comment"># keep these as properties for display purposes</span></span><br><span class="line">  match.uppercase_entropy = <span class="property">@extra_uppercase_entropy</span> match</span><br><span class="line">  match.reversed_entropy = match.reversed <span class="keyword">and</span> <span class="number">1</span> <span class="keyword">or</span> <span class="number">0</span></span><br><span class="line">  match.l33t_entropy = <span class="property">@extra_l33t_entropy</span>(match)</span><br><span class="line">  match.base_entropy + match.uppercase_entropy + match.l33t_entropy + match.reversed_entropy</span><br><span class="line"></span><br><span class="line"><span class="attribute">START_UPPER</span>: <span class="regexp">/^[A-Z][^A-Z]+$/</span></span><br><span class="line"><span class="attribute">END_UPPER</span>: <span class="regexp">/^[^A-Z]+[A-Z]$/</span></span><br><span class="line"><span class="attribute">ALL_UPPER</span>: <span class="regexp">/^[^a-z]+$/</span></span><br><span class="line"><span class="attribute">ALL_LOWER</span>: <span class="regexp">/^[^A-Z]+$/</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">extra_uppercase_entropy</span>: <span class="function"><span class="params">(match)</span> -&gt;</span></span><br><span class="line">  word = match.token</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span> <span class="keyword">if</span> word.match <span class="property">@ALL_LOWER</span></span><br><span class="line">  <span class="comment"># a capitalized word is the most common capitalization scheme,</span></span><br><span class="line">  <span class="comment"># so it only doubles the search space (uncapitalized + capitalized): 1 extra bit of entropy.</span></span><br><span class="line">  <span class="comment"># allcaps and end-capitalized are common enough too, underestimate as 1 extra bit to be safe.</span></span><br><span class="line">  <span class="keyword">for</span> regex <span class="keyword">in</span> [<span class="property">@START_UPPER</span>, <span class="property">@END_UPPER</span>, <span class="property">@ALL_UPPER</span>]</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> <span class="keyword">if</span> word.match regex</span><br><span class="line">  <span class="comment"># otherwise calculate the number of ways to capitalize U+L uppercase+lowercase letters</span></span><br><span class="line">  <span class="comment"># with U uppercase letters or less. or, if there's more uppercase than lower (for eg. PASSwORD),</span></span><br><span class="line">  <span class="comment"># the number of ways to lowercase U+L letters with L lowercase letters or less.</span></span><br><span class="line">  U = (chr <span class="keyword">for</span> chr <span class="keyword">in</span> word.split(<span class="string">''</span>) <span class="keyword">when</span> chr.match <span class="regexp">/[A-Z]/</span>).length</span><br><span class="line">  L = (chr <span class="keyword">for</span> chr <span class="keyword">in</span> word.split(<span class="string">''</span>) <span class="keyword">when</span> chr.match <span class="regexp">/[a-z]/</span>).length</span><br><span class="line">  possibilities = <span class="number">0</span></span><br><span class="line">  possibilities += <span class="property">@nCk</span>(U + L, i) <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">1.</span>.Math.min(U, L)]</span><br><span class="line">  <span class="property">@lg</span> possibilities</span><br><span class="line"></span><br><span class="line"><span class="attribute">extra_l33t_entropy</span>: <span class="function"><span class="params">(match)</span> -&gt;</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span> <span class="keyword">if</span> <span class="keyword">not</span> match.l33t</span><br><span class="line">  extra_entropy = <span class="number">0</span></span><br><span class="line">  <span class="keyword">for</span> subbed, unsubbed <span class="keyword">of</span> match.sub</span><br><span class="line">    <span class="comment"># lower-case match.token before calculating: capitalization shouldn't affect l33t calc.</span></span><br><span class="line">    chrs = match.token.toLowerCase().split(<span class="string">''</span>)</span><br><span class="line">    S = (chr <span class="keyword">for</span> chr <span class="keyword">in</span> chrs <span class="keyword">when</span> chr == subbed).length   <span class="comment"># num of subbed chars</span></span><br><span class="line">    U = (chr <span class="keyword">for</span> chr <span class="keyword">in</span> chrs <span class="keyword">when</span> chr == unsubbed).length <span class="comment"># num of unsubbed chars</span></span><br><span class="line">    <span class="keyword">if</span> S == <span class="number">0</span> <span class="keyword">or</span> U == <span class="number">0</span></span><br><span class="line">      <span class="comment"># for this sub, password is either fully subbed (444) or fully unsubbed (aaa)</span></span><br><span class="line">      <span class="comment"># treat that as doubling the space (attacker needs to try fully subbed chars in addition to</span></span><br><span class="line">      <span class="comment"># unsubbed.)</span></span><br><span class="line">      extra_entropy += <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="comment"># this case is similar to capitalization:</span></span><br><span class="line">      <span class="comment"># with aa44a, U = 3, S = 2, attacker needs to try unsubbed + one sub + two subs</span></span><br><span class="line">      p = Math.min(U, S)</span><br><span class="line">      possibilities = <span class="number">0</span></span><br><span class="line">      possibilities += <span class="property">@nCk</span>(U + S, i) <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">1.</span>.p]</span><br><span class="line">      extra_entropy += <span class="property">@lg</span> possibilities</span><br><span class="line">  extra_entropy</span><br></pre></td></tr></table></figure>
<p>其他匹配的计算方法就不罗列了，根据entropy计算score仅仅是数值上的变换，所以这里也略去了。</p>
<h2 id="section-3">4</h2>
<p>我们再看一下计算字典匹配entropy的函数，其中计算base_entroy的公式可以再讨论一下。这种密码的列表很容易从Mark Burnett的网站中找到，甚至也可以自己统计现有泄露的密码库，但是转成这种列表之后实际上丢失了概率信息，仅仅保留了一个排名信息。</p>
<p>如果攻击者有几个完整的泄露密码库，他们还能从其中提取哪些有用的信息呢？我们如何利用这些信息评估未知密码的强度呢？</p>
<p>下一篇再谈。</p>
 -->
	
	</div>
  <a type="button" href="/2015/09/22/password-strengths-evaluation-entropy/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-08-26 </div>
			<div class="article-title"><a href="/2015/08/26/RSA-PKCS1-V1-5-Padding/" >BigInteger#toByteArray引发的处理PKCS1Padding的问题</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		
		<!-- <h2 id="section">1</h2>
<p>之前的<a href="http://shichaoyuan.github.io/2015/07/10/notes-pepfcp/">文章</a>提到过使用RSA加密传输密码的应用场景，在和H5联调的时候遇到了不少问题……</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Cipher cipher = Cipher.getInstance(<span class="string">"RSA/ECB/PKCS1Padding"</span>);</span><br><span class="line">cipher.init(Cipher.DECRYPT_MODE, prikey);</span><br></pre></td></tr></table></figure>
<p>后端限定的RSA解密实现如上所示；H5前端发来的消息，偶尔会报下述异常：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Caused by: javax.crypto.BadPaddingException: Data must start with zero</span><br><span class="line">	at sun.security.rsa.RSAPadding.unpadV15(RSAPadding.java:<span class="number">308</span>)</span><br><span class="line">	at sun.security.rsa.RSAPadding.unpad(RSAPadding.java:<span class="number">255</span>)</span><br><span class="line">	at com.sun.crypto.provider.RSACipher.a(DashoA13*..)</span><br><span class="line">	at com.sun.crypto.provider.RSACipher.engineDoFinal(DashoA13*..)</span><br><span class="line">	at javax.crypto.Cipher.doFinal(DashoA13*..)</span><br></pre></td></tr></table></figure>
<p>之前概率不大，一直没太关心，最近发现失败的情况还挺多，所以查了一下，顺便做个笔记。</p>
<h2 id="section-1">2</h2>
<p>首先跟一下异常抛出的位置，线上用的是jdk1.6，所以先到<a href="http://hg.openjdk.java.net/jdk6/jdk6/jdk/" class="uri" target="_blank" rel="external">http://hg.openjdk.java.net/jdk6/jdk6/jdk/</a>这里下载一下源码，定位到文件，看了一下，实现上差别挺大。</p>
<p>怎么办？使用Bytecode反编译吧。</p>
<p>抛异常的位置在这儿：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">byte</span>[] unpadV15(<span class="keyword">final</span> <span class="keyword">byte</span>[] array) <span class="keyword">throws</span> BadPaddingException &#123;</span><br><span class="line">    <span class="keyword">int</span> n = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (array[n++] != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BadPaddingException(<span class="string">"Data must start with zero"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (array[n++] != <span class="keyword">this</span>.type) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BadPaddingException(<span class="string">"Blocktype mismatch: "</span> + array[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> n2 = array[n++] &amp; <span class="number">0xFF</span>;</span><br><span class="line">        <span class="keyword">if</span> (n2 == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> n3 = array.length - n;</span><br><span class="line">            <span class="keyword">if</span> (n3 &gt; <span class="keyword">this</span>.maxDataSize) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BadPaddingException(<span class="string">"Padding string too short"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">byte</span>[] array2 = <span class="keyword">new</span> <span class="keyword">byte</span>[n3];</span><br><span class="line">            System.arraycopy(array, array.length - n3, array2, <span class="number">0</span>, n3);</span><br><span class="line">            <span class="keyword">return</span> array2;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (n == array.length) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BadPaddingException(<span class="string">"Padding string not terminated"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.type == <span class="number">1</span> &amp;&amp; n2 != <span class="number">255</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BadPaddingException(<span class="string">"Padding byte not 0xff: "</span> + n2);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也就是说解密之后开始的第一个byte不是0……</p>
<p>好的，我们再看一下异常的消息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">byte</span>[] passwordBytes = <span class="keyword">new</span> BigInteger(encryptedPassword, <span class="number">16</span>).toByteArray()</span><br></pre></td></tr></table></figure>
<p>后端这里使用上述方式，将十六进制的消息转成byte数组，打印出来：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#24322;&#24120;&#30340;&#28040;&#24687;&#65306;&#10;93e15ed1e75e5e5f51d45498fd704d96a0e7fc6892bca10dc2976bb1d39659e0ea3eb0b586dcb2f5f491e8d3f4db07e5856406634f64ac0c307181a9a52d4fb75dc872b3bb070ea6bacdcaa0a78cdd9330dc91d33141852669068896754161dee37a51fcb1d74690ab2e5387cede616adf29472058f4d669500710b68d0d8eeea0fb2fc4a703e13ef3179dba8ba00c6a59ab9048c8847af06c2d9e82a00355bae44762fda6ceee6ac69c4c47638a17ba39a4135c6ee0175f7c8e0c46f280925a1f15e5f9ea43bfa64d6c16ea59f011605c32b7f4a0c5b09dd0c178b68e0cce3413ff03db13eddc4bc3a84062310d3f540d34bca4bfc648699a83145b21753d6f&#10;&#10;  0: 00000000 10010011 11100001 01011110 11010001 11100111 01011110 01011110&#10;  8: 01011111 01010001 11010100 01010100 10011000 11111101 01110000 01001101&#10;&#8230;&#8230;&#30465;&#30053;  &#10;248: 01101001 10011010 10000011 00010100 01011011 00100001 01110101 00111101&#10;256: 01101111&#10;&#10;&#10;&#27491;&#24120;&#30340;&#28040;&#24687;&#65306;&#10;5eb2dc0d2c675a60830ea92ccb3c514a26fcdc6a7d2621d905ba0cb3eb02ce0bac052cf1833022a0a9ebccf546b0a3a8d50f165a6ae0b7c86840f09b99e32bf25e614ff2ca59bdc220377effde60f6d464d13f8403ad0f5e03fa79985eb0c842743eb3179211a0438d7dabe8567c11871b5d1182d1cb8cd58b9a06777463c62f79d0c1fdfb01a0a637906919e58ca9cd9d8d2e883655e5b7401ce16e0d507bea97f8a54a44231b88b4a7d65133949aacdde8c0e672a21f6bc8277ed0abc8ac4239a909007db3b8063c82d70af7df665550cb79fded779e9f92ff6c4c6b2cda17879b6a3e854b77224ebec5b0095b2f1123e7730d62c188eac9f6019dd7cff3a3&#10;&#10;  0: 01011110 10110010 11011100 00001101 00101100 01100111 01011010 01100000&#10;  8: 10000011 00001110 10101001 00101100 11001011 00111100 01010001 01001010&#10;&#8230;&#8230;&#30465;&#30053;&#10;240: 00100011 11100111 01110011 00001101 01100010 11000001 10001000 11101010&#10;248: 11001001 11110110 00000001 10011101 11010111 11001111 11110011 10100011</span><br></pre></td></tr></table></figure>
<p>我们发现异常的消息前面多了一个为0的byte，问题出在BigInteger的toByteArray方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] toByteArray() &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> n = <span class="keyword">this</span>.bitLength() / <span class="number">8</span> + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">byte</span>[] array = <span class="keyword">new</span> <span class="keyword">byte</span>[n];</span><br><span class="line">    <span class="keyword">int</span> i = n - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> n2 = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">int</span> int1 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> n3 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (n2 == <span class="number">4</span>) &#123;</span><br><span class="line">            int1 = <span class="keyword">this</span>.getInt(n3++);</span><br><span class="line">            n2 = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            int1 &gt;&gt;&gt;= <span class="number">8</span>;</span><br><span class="line">            ++n2;</span><br><span class="line">        &#125;</span><br><span class="line">        array[i] = (<span class="keyword">byte</span>)int1;</span><br><span class="line">        --i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> array;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果bit长度是8的倍数，前面就会多一个为0的byte……所以自己写一个转换方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] hexStringToByteArray(String s) &#123;</span><br><span class="line">    <span class="keyword">int</span> len = s.length();</span><br><span class="line">    <span class="keyword">byte</span>[] data = <span class="keyword">new</span> <span class="keyword">byte</span>[len / <span class="number">2</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i += <span class="number">2</span>) &#123;</span><br><span class="line">        data[i / <span class="number">2</span>] = (<span class="keyword">byte</span>) ((Character.digit(s.charAt(i), <span class="number">16</span>) &lt;&lt; <span class="number">4</span>)</span><br><span class="line">                                 + Character.digit(s.charAt(i+<span class="number">1</span>), <span class="number">16</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试了几次都没有问题……</p>
<p>所以偶尔得多看看JDK的实现，一不小心使用的姿势就不对了……</p>
<h2 id="section-2">3</h2>
<p>最后贴点儿资料</p>
<p><a href="https://tools.ietf.org/html/rfc3447" target="_blank" rel="external">rfc3447</a> RSA加密规范</p>
<p><a href="http://etherhack.co.uk/asymmetric/docs/rsa_key_breakdown.html" target="_blank" rel="external">OpenSSL 1024 bit RSA Private Key Breakdown</a> Key文件描述</p>
 -->
	
	</div>
  <a type="button" href="/2015/08/26/RSA-PKCS1-V1-5-Padding/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-08-13 </div>
			<div class="article-title"><a href="/2015/08/13/slick-upsert/" >Slick中的upsert操作</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		
		<!-- <h2 id="section">1</h2>
<p>在做一个Single Page Application，然后使用三方登陆，不维护账号信息，每次登陆拉一次最新的三方账户信息。</p>
<p>所以数据库操作就有个问题，没有注册，insert，老用户，update，俗称upsert。</p>
<h2 id="section-1">2</h2>
<p>使用mysql直接写SQL语句很简单：</p>
<p><a href="http://dev.mysql.com/doc/refman/5.6/en/insert-on-duplicate.html" target="_blank" rel="external"><code>INSERT ... ON DUPLICATE KEY UPDATE</code></a></p>
<h2 id="section-2">3</h2>
<p>但是这个小项目使用<a href="https://www.playframework.com/documentation/2.4.x/PlaySlick" target="_blank" rel="external"><code>play-slick 1.0.1</code></a></p>
<p>刚开始学着用，就捣鼓出了这样一段逻辑</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">insert</span>(</span>user: <span class="type">User</span>): <span class="type">Future</span>[<span class="type">Int</span>] = db.run(<span class="type">Users</span> += user)</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span>(</span>user: <span class="type">User</span>): <span class="type">Future</span>[<span class="type">Int</span>] = &#123;</span><br><span class="line">  db.run(<span class="type">Users</span>.filter(_.id === user.id.get).update(user))</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">selectByQQOpenID</span>(</span>qqOpenID: <span class="type">String</span>): <span class="type">Future</span>[<span class="type">Option</span>[<span class="type">User</span>]] = db.run( <span class="type">Users</span>.filter(_.qqOpenID === qqOpenID).result.headOption )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">createOrUpdateUserByOpenID</span>(</span>openID: <span class="type">String</span>, userInfo: <span class="type">UserInfo</span>): <span class="type">Future</span>[<span class="type">Int</span>] = &#123;</span><br><span class="line">	<span class="function"><span class="keyword">val</span> <span class="title">user</span> =</span> userDAO.selectByQQOpenID(openID)</span><br><span class="line">	user.flatMap &#123; </span><br><span class="line">		<span class="keyword">case</span> <span class="type">Some</span>(u) =&gt; userDAO.update(u.copy(name = userInfo.name, headURL = userInfo.headURL))</span><br><span class="line">		<span class="keyword">case</span> <span class="type">None</span> =&gt; userDAO.insert(<span class="type">User</span>(<span class="type">None</span>, userInfo.name, userInfo.headURL, openID))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="section-3">4</h2>
<p>感觉不漂亮，搜了一下，原来还挺多研究这个问题的……</p>
<p>比如：<a href="http://underscore.io/blog/posts/2015/07/14/upsert.html" target="_blank" rel="external">Upsert in Slick 3</a></p>
<p>原来有个内建的<code>insertOrUpdate</code>，代码提示居然没让我看到……</p>
<p>所以对于单主键</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">postReview</span>(</span>title: <span class="type">String</span>, rating: <span class="type">Int</span>): <span class="type">DBIO</span>[<span class="type">Int</span>] = <span class="keyword">for</span> &#123;</span><br><span class="line">  existing &lt;- reviews.filter(_.title === title).result.headOption</span><br><span class="line">  row       = existing.map(_.copy(rating=rating)) getOrElse <span class="type">Review</span>(title, rating)</span><br><span class="line">  result  &lt;- reviews.insertOrUpdate(row)</span><br><span class="line">&#125; <span class="keyword">yield</span> result</span><br></pre></td></tr></table></figure>
<p>对于联合主键</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">postReview</span>(</span>critic: <span class="type">String</span>, title: <span class="type">String</span>, rating: <span class="type">Int</span>): <span class="type">DBIO</span>[<span class="type">Int</span>] = <span class="keyword">for</span> &#123;</span><br><span class="line">  existing &lt;- reviews.filter(r =&gt; r.title === title &amp;&amp; r.critic === critic).result.headOption</span><br><span class="line">  row       = existing.map(_.copy(rating=rating)) getOrElse <span class="type">Review</span>(critic, title, rating)</span><br><span class="line">  result  &lt;- reviews.insertOrUpdate(row)</span><br><span class="line">&#125; <span class="keyword">yield</span> result</span><br></pre></td></tr></table></figure>
<p>当然也可以纯手工</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">postReview</span>(</span>critic: <span class="type">String</span>, title: <span class="type">String</span>, rating: <span class="type">Int</span>)(<span class="keyword">implicit</span> ec: <span class="type">ExecutionContext</span>): <span class="type">DBIO</span>[<span class="type">Int</span>] = &#123;</span><br><span class="line">  <span class="keyword">for</span> &#123;</span><br><span class="line">    rowsAffected &lt;- reviews.filter(r =&gt; r.critic === critic &amp;&amp; r.title === title).map(_.rating).update(rating)</span><br><span class="line">    result &lt;- rowsAffected <span class="keyword">match</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0</span> =&gt; reviews += <span class="type">Review</span>(critic, title, rating)</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span> =&gt; <span class="type">DBIO</span>.successful(<span class="number">1</span>)</span><br><span class="line">      <span class="keyword">case</span> n =&gt; <span class="type">DBIO</span>.failed(<span class="keyword">new</span> <span class="type">RuntimeException</span>(s<span class="string">"Expected 0 or 1 change, not $n for $critic @ $title"</span>))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">yield</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
 -->
	
	</div>
  <a type="button" href="/2015/08/13/slick-upsert/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-08-06 </div>
			<div class="article-title"><a href="/2015/08/06/startup-web-playframework/" >如何快速开始一个小项目 —— playframework</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		
		<!-- <h2 id="section">1</h2>
<p>基本文档 <a href="https://www.playframework.com/documentation/2.4.x/Home" target="_blank" rel="external">Play 2.4.x documentation</a></p>
<h2 id="section-1">2</h2>
<p>生成框架 <a href="https://www.playframework.com/documentation/2.4.x/NewApplication" target="_blank" rel="external">Creating a new application</a></p>
<p>导入Eclipse <a href="https://www.playframework.com/documentation/2.4.x/IDE#Eclipse" target="_blank" rel="external">Setting up your preferred IDE</a></p>
<p><strong>NOTE</strong> 目前<code>Scala IDE</code>的4.1.1版本的play plugin有问题，可以暂时自行编译安装<a href="https://github.com/cweinreben/scala-ide-play2" class="uri" target="_blank" rel="external">https://github.com/cweinreben/scala-ide-play2</a>这个fork。</p>
<h2 id="section-2">3</h2>
<p>连接数据库</p>
<p><a href="http://slick.typesafe.com/" target="_blank" rel="external"><strong>Slick</strong></a></p>
<p>用于连接MySQL，详见文档<a href="https://www.playframework.com/documentation/2.4.x/PlaySlick" target="_blank" rel="external">PlaySlick</a></p>
<p><a href="http://reactivemongo.org/" target="_blank" rel="external"><strong>ReactiveMongo</strong></a></p>
<p>用于连接MongoDB，详见文档<a href="http://reactivemongo.org/releases/0.11/documentation/tutorial/play2.html" target="_blank" rel="external">Reactive Scala Driver for MongoDB</a></p>
<h2 id="section-3">4</h2>
<p>Log</p>
<p>基本上就是配置logback</p>
<p><a href="https://www.playframework.com/documentation/2.4.x/SettingsLogger" target="_blank" rel="external">Configuring logging</a></p>
<p><a href="https://www.playframework.com/documentation/2.4.x/ScalaLogging" target="_blank" rel="external">The Logging API</a></p>
<p>文档中还很贴心的给出了两种实现accesslog的方法。</p>
<h2 id="section-4">5</h2>
<p>部署服务</p>
<p><a href="https://www.playframework.com/documentation/2.4.x/Production" target="_blank" rel="external">Deploying your application</a></p>
 -->
	
	</div>
  <a type="button" href="/2015/08/06/startup-web-playframework/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-08-05 </div>
			<div class="article-title"><a href="/2015/08/05/startup-web-spring/" >如何快速开始一个小项目 —— spring-boot</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		
		<!-- <p><strong>UPDATE 20150813</strong></p>
<p>最近帮朋友搭了一些小东东，用得都是开源的东东，感觉都还挺方便，基本上稍微配置一下就可以开始一个小项目。</p>
<p>所以简单记一下。</p>
<p>这篇记录spring-boot</p>
<h2 id="section">1</h2>
<p>基本的框架：<a href="http://spring.io/guides/gs/rest-service/" target="_blank" rel="external">Building a RESTful Web Service</a></p>
<p>基本的文档：<a href="http://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/" target="_blank" rel="external">Spring Boot Reference Guide</a></p>
<h2 id="section-1">2</h2>
<p>连接MySQL</p>
<p><code>pom.xml</code></p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">spring</span>-boot-starter-<span class="typedef"><span class="keyword">data</span>-jpa</span></span><br><span class="line"><span class="title">mysql</span>-connector-java //不要漏了</span><br></pre></td></tr></table></figure>
<p><code>application.properties</code></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">spring<span class="class">.datasource</span><span class="class">.url</span>=jdbc:mysql:<span class="comment">//localhost/xxx</span></span><br><span class="line">spring<span class="class">.datasource</span><span class="class">.username</span>=xxx</span><br><span class="line">spring<span class="class">.datasource</span><span class="class">.password</span>=xxx</span><br><span class="line">spring<span class="class">.datasource</span><span class="class">.driver-class-name</span>=com<span class="class">.mysql</span><span class="class">.jdbc</span><span class="class">.Driver</span></span><br></pre></td></tr></table></figure>
<p>一些annotation</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Query</span>(<span class="string">"select u from User u where u.email = ?1 "</span>)</span><br><span class="line"></span><br><span class="line"><span class="annotation">@Transactional</span>(rollbackFor=RuntimeException.class)</span><br></pre></td></tr></table></figure>
<p>处理autoReconnect</p>
<p><a href="http://stackoverflow.com/questions/22684807/spring-boot-jpa-configuring-auto-reconnect" target="_blank" rel="external">Spring Boot JPA - configuring auto reconnect</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spring.datasource.testOnBorrow=true&#10;spring.datasource.validationQuery=SELECT 1</span><br></pre></td></tr></table></figure>
<p>update操作</p>
<p><a href="http://codingexplained.com/coding/java/spring-framework/updating-entities-with-update-query-spring-data-jpa" target="_blank" rel="external">Updating Entities with Update Query in Spring Data JPA</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CompanyRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Company</span>, <span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line">    <span class="annotation">@Modifying</span></span><br><span class="line">    <span class="annotation">@Query</span>(<span class="string">"UPDATE Company c SET c.address = :address WHERE c.id = :companyId"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">updateAddress</span><span class="params">(@Param(<span class="string">"companyId"</span>)</span> <span class="keyword">int</span> companyId, @<span class="title">Param</span><span class="params">(<span class="string">"address"</span>)</span> String address)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>native操作</p>
<p>application.properties</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spring.jpa.database=MYSQL&#10;spring.jpa.hibernate.dialect=org.hibernate.dialect.MySQL5Dialect</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Modifying</span></span><br><span class="line"><span class="annotation">@Query</span>(value = <span class="string">"insert ignore into "</span> + TABLE_NAME + <span class="string">"("</span> + INSERT_FIELD + <span class="string">")"</span> + <span class="string">" values (:fid, :tid, :date) "</span>, nativeQuery = <span class="keyword">true</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">setFollowed</span><span class="params">(@Param(<span class="string">"fid"</span>)</span> <span class="keyword">long</span> fromId, @<span class="title">Param</span><span class="params">(<span class="string">"tid"</span>)</span> <span class="keyword">long</span> toId, @<span class="title">Param</span><span class="params">(<span class="string">"date"</span>)</span> Date date)</span>;</span><br></pre></td></tr></table></figure>
<h2 id="section-2">3</h2>
<p>处理异常以及返回结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalExceptionHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@ExceptionHandler</span>(&#123; UnAuthenticationException.class &#125;)</span><br><span class="line">	<span class="annotation">@ResponseBody</span></span><br><span class="line">	<span class="keyword">public</span> ResponseEntity&lt;?&gt; handleUnauthenticationException(Exception e) &#123;</span><br><span class="line">		<span class="keyword">return</span> errorResponse(e, HttpStatus.UNAUTHORIZED);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@ExceptionHandler</span>(&#123; Exception.class &#125;)</span><br><span class="line">	<span class="annotation">@ResponseBody</span></span><br><span class="line">	<span class="keyword">public</span> ResponseEntity&lt;?&gt; handleAnyException(Exception e) &#123;</span><br><span class="line">		<span class="keyword">return</span> errorResponse(e, HttpStatus.INTERNAL_SERVER_ERROR);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> ResponseEntity&lt;Result&gt; <span class="title">errorResponse</span><span class="params">(Throwable throwable, HttpStatus status)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">null</span> != throwable) &#123;</span><br><span class="line">			<span class="keyword">return</span> response(<span class="keyword">new</span> Result(<span class="keyword">new</span> Meta(status.value(), throwable.getMessage())), status);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> response(<span class="keyword">new</span> Result(<span class="keyword">new</span> Meta(status.value(), <span class="string">""</span>)), status);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> &lt;T&gt; <span class="function">ResponseEntity&lt;T&gt; <span class="title">response</span><span class="params">(T body, HttpStatus status)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;T&gt;(body, <span class="keyword">new</span> HttpHeaders(), status);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>处理JSON</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@JsonInclude</span>(Include.NON_NULL)</span><br><span class="line"><span class="annotation">@JsonIgnore</span></span><br></pre></td></tr></table></figure>
<h2 id="section-3">4</h2>
<p>日志</p>
<p><code>application.properties</code></p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">logging.<span class="keyword">file</span>=xxx.<span class="literal">log</span></span><br><span class="line">logging.path=/<span class="keyword">var</span>/<span class="literal">log</span></span><br></pre></td></tr></table></figure>
<p>或者自定义<code>logback.xml</code>文件</p>
<p>比较全的<code>application.properties</code>例子见<a href="http://docs.spring.io/spring-boot/docs/current/reference/html/common-application-properties.html" target="_blank" rel="external">文档</a></p>
<p>例如，access log</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">server.tomcat.<span class="keyword">access</span>-<span class="built_in">log</span>-pattern= # <span class="built_in">log</span> pattern of the <span class="keyword">access</span> <span class="built_in">log</span></span><br><span class="line">server.tomcat.<span class="keyword">access</span>-<span class="built_in">log</span>-enabled=false # is <span class="keyword">access</span> logging enabled</span><br></pre></td></tr></table></figure>
<h2 id="section-4">5</h2>
<p>Interceptor</p>
<p><a href="http://www.concretepage.com/spring/spring-mvc/spring-handlerinterceptor-annotation-example-webmvcconfigureradapter" target="_blank" rel="external">Spring MVC HandlerInterceptor Annotation Example with WebMvcConfigurerAdapter</a></p>
<p>这篇文章写得蛮清楚的，唯一需要注意的是：<a href="http://stackoverflow.com/questions/31082981/spring-boot-adding-http-request-interceptors" target="_blank" rel="external">do not annotate this with EnableWebMvc, if you want to keep Spring Boots auto configuration for mvc</a></p>
<h2 id="section-5">6</h2>
<p>未完待续</p>
<h2 id="section-6">0</h2>
<p>一些好用的三方库</p>
<ol style="list-style-type: decimal">
<li>PBKDF2 <a href="https://github.com/qaware/heimdall" target="_blank" rel="external">heimdall</a></li>
<li>JWT <a href="https://github.com/auth0/java-jwt" target="_blank" rel="external">java-jwt</a></li>
</ol>
 -->
	
	</div>
  <a type="button" href="/2015/08/05/startup-web-spring/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-07-10 </div>
			<div class="article-title"><a href="/2015/07/10/notes-pepfcp/" >Reading Notes - Prudent Engineering Practice for Cryptographic Protocols</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		
		<!-- <h2 id="section">1</h2>
<p>最近在做一个关于支付的小需求，其中有个关于支付密码的地方，由于运维短时间内提供不了HTTPS，所以需要设计一个简单的加密协议，保证密码不能泄露，不能被重放攻击。</p>
<p>如何做？</p>
<p>使用RSA算法，客户端内置一个公钥（或者动态获取），服务器保存一个私钥，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1. server -------------nonce-----------&#62; client&#10;2. server &#60;---encrypt(passowrd+nonce)--- client&#10;&#10;server decrypt(message) and check(password+nonce)</span><br></pre></td></tr></table></figure>
<p>当然密码存储不当也存在泄露的问题，解决这个问题可以使用PBKDF2(<a href="https://tools.ietf.org/html/rfc2898" target="_blank" rel="external">rfc2898</a>)。至于迭代次数可以参考stackexchange中的这个<a href="http://security.stackexchange.com/questions/3959/recommended-of-iterations-when-using-pkbdf2-sha256" target="_blank" rel="external">问题</a>。</p>
<p>另外终端安全坑太大，暂时不考虑。</p>
<p>然后又想起读书的时候上《安全协议》那门课读的那些论文，其中有一篇感觉相当经典，所以又找出来读了一遍。</p>
<h2 id="section-1">2</h2>
<p><a href="http://ieeexplore.ieee.org/xpl/articleDetails.jsp?arnumber=481513&amp;filter%3DAND%28p_IS_Number%3A10294%29" target="_blank" rel="external">Prudent Engineering Practice for Cryptographic Protocols</a></p>
<h3 id="principle-1">Principle 1</h3>
<blockquote>
<p>Every message should say what it means: the interpretation of the message should depend only on its content. It should be possible to write down a straightforward English sentence describing the content – though if there is a suitable formalism available that is good too.</p>
</blockquote>
<h3 id="principle-2">Principle 2</h3>
<blockquote>
<p>The conditions for a message to be acted upon should be clearly set out so that someone reviewing a design may see whether they are acceptable or not.</p>
</blockquote>
<h3 id="principle-3">Principle 3</h3>
<blockquote>
<p>If the identity of a principal is essential to the meaning of a message, it is prudent to mention the principal’s name explicitly in the message.</p>
</blockquote>
<h3 id="principle-4">Principle 4</h3>
<blockquote>
<p>Be clear as to why encryption is being done. Encryption is not wholly cheap, and not asking precisely why it is being done can lead to redundancy. Encryption is not synonymous with security, and its improper use can lead to errors. ###Principle 5 When a principal signs material that has already been encrypted, it should not be inferred that the principal knows the content of the message. On the other hand, it is proper to infer that the principal that signs a message and then encrypts it for privacy knows the content of the message.</p>
</blockquote>
<h3 id="principle-6">Principle 6</h3>
<blockquote>
<p>Be clear what properties you are assuming about nonces. What may do for ensuring temporal succession may not do for ensuring association – and perhaps association is best established by other means.</p>
</blockquote>
<h3 id="principle-7">Principle 7</h3>
<blockquote>
<p>The use of a predictable quantity (such as the value of a counter) can serve in guaranteeing newness, through a challenge-response exchange. But if a predictable quantity is to be effective, it should be protected so that an intruder cannot simulate a challenge and later replay a response.</p>
</blockquote>
<h3 id="principle-8">Principle 8</h3>
<blockquote>
<p>If timestamps are used as freshness guarantees by reference to absolute time, then the difference between local clocks at various machines must be much less than the allowable age of a message deemed to be valid. Furthermore, the time maintenance mechanism everywhere becomes part of the trusted computing base.</p>
</blockquote>
<h3 id="principle-9">Principle 9</h3>
<blockquote>
<p>A key may have been used recently, for example to encrypt a nonce, yet be quite old, and possibly compromised. Recent use does not make the key look any better than it would otherwise.</p>
</blockquote>
<h3 id="principle-10">Principle 10</h3>
<blockquote>
<p>If an encoding is used to present the meaning of a message, then it should be possible to tell which encoding is being used. In the common case where the encoding is protocol dependent, it should be possible to deduce that the message belongs to this protocol, and in fact to a particular run of the protocol, and to know its number in the protocol.</p>
</blockquote>
<h3 id="principle-11">Principle 11</h3>
<blockquote>
<p>The protocol designer should know which trust relations his protocol depends on, and why the dependence is necessary. The reasons for particular trust relations being acceptable should be explicit though they will be founded on judgement and policy rather than on logic.</p>
</blockquote>
 -->
	
	</div>
  <a type="button" href="/2015/07/10/notes-pepfcp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-06-30 </div>
			<div class="article-title"><a href="/2015/06/30/weak-reference/" >weak reference</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		
		<!-- <h2 id="section">1</h2>
<p>最近看了一篇文章<a href="http://www.javaspecialists.eu/archive/Issue164.html" target="_blank" rel="external">Why 0x61c88647?</a>，感觉写的很细致。</p>
<p>关于<code>ThreadLocal</code>的问题，这里就不复述了。</p>
<p>文章在讲解<code>ThreadLocal</code>的实现的时候，提到了<code>WeakReference</code>。</p>
<p>感觉还是挺陌生的，印象中在用<code>Guava</code>的<code>Cache</code>的时候遇到过设置<code>key</code>和<code>value</code>为<code>weak</code>状态。（不过使用的时候也没配置过相关的选项……）</p>
<p>大致了解是跟GC有关系，其它就不清楚了，所以就多google一下吧。</p>
<h2 id="section-1">2</h2>
<p><a href="https://weblogs.java.net/blog/2006/05/04/understanding-weak-references" target="_blank" rel="external">Understanding Weak References</a></p>
<p>找到这篇文章，感觉介绍的挺直观。</p>
<p>简单总结一下：</p>
<p>通常的Java引用是strong reference。但是对于有些场景，比如做为缓存的<code>Map</code>，需要维护增减的键值，就有点类似于手动地分配、释放内存，这就失去自动垃圾回收的优势了嘛。</p>
<p>所以就可以使用<code>WeakHashMap</code>，其中的键是弱引用的，GC就可以回收到，顺便值也自动回收了。</p>
<p>另外，“弱”的程度：</p>
<p>Soft references：weak和strong是发现了就回收，而soft得等等。</p>
<p>Phantom references：感觉使用场景想不太到。</p>
<h2 id="section-2">3</h2>
<p>看一下<code>WeakHashMap</code>的实现吧~</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeakHashMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span><br><span class="line">    <span class="keyword">extends</span> <span class="title">AbstractMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span><br><span class="line">    <span class="keyword">implements</span> <span class="title">Map</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * The table, resized as necessary. Length MUST Always be a power of two.</span><br><span class="line">     */</span></span><br><span class="line">    Entry&lt;K,V&gt;[] table;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Reference queue for cleared WeakEntries</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReferenceQueue&lt;Object&gt; queue = <span class="keyword">new</span> ReferenceQueue&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Associates the specified value with the specified key in this map.</span><br><span class="line">     * If the map previously contained a mapping for this key, the old</span><br><span class="line">     * value is replaced.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> key key with which the specified value is to be associated.</span><br><span class="line">     * <span class="doctag">@param</span> value value to be associated with the specified key.</span><br><span class="line">     * <span class="doctag">@return</span> the previous value associated with &lt;tt&gt;key&lt;/tt&gt;, or</span><br><span class="line">     *         &lt;tt&gt;null&lt;/tt&gt; if there was no mapping for &lt;tt&gt;key&lt;/tt&gt;.</span><br><span class="line">     *         (A &lt;tt&gt;null&lt;/tt&gt; return can also indicate that the map</span><br><span class="line">     *         previously associated &lt;tt&gt;null&lt;/tt&gt; with &lt;tt&gt;key&lt;/tt&gt;.)</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">        Object k = maskNull(key);</span><br><span class="line">        <span class="keyword">int</span> h = hash(k);</span><br><span class="line">        Entry&lt;K,V&gt;[] tab = getTable();</span><br><span class="line">        <span class="keyword">int</span> i = indexFor(h, tab.length);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Entry&lt;K,V&gt; e = tab[i]; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">            <span class="keyword">if</span> (h == e.hash &amp;&amp; eq(k, e.get())) &#123;</span><br><span class="line">                V oldValue = e.value;</span><br><span class="line">                <span class="keyword">if</span> (value != oldValue)</span><br><span class="line">                    e.value = value;</span><br><span class="line">                <span class="keyword">return</span> oldValue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        modCount++;</span><br><span class="line">        Entry&lt;K,V&gt; e = tab[i];</span><br><span class="line">        tab[i] = <span class="keyword">new</span> Entry&lt;&gt;(k, value, queue, h, e);</span><br><span class="line">        <span class="keyword">if</span> (++size &gt;= threshold)</span><br><span class="line">            resize(tab.length * <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Returns the value to which the specified key is mapped,</span><br><span class="line">     * or &#123;<span class="doctag">@code</span> null&#125; if this map contains no mapping for the key.</span><br><span class="line">     *</span><br><span class="line">     * &lt;p&gt;More formally, if this map contains a mapping from a key</span><br><span class="line">     * &#123;<span class="doctag">@code</span> k&#125; to a value &#123;<span class="doctag">@code</span> v&#125; such that &#123;<span class="doctag">@code</span> (key==null ? k==null :</span><br><span class="line">     * key.equals(k))&#125;, then this method returns &#123;<span class="doctag">@code</span> v&#125;; otherwise</span><br><span class="line">     * it returns &#123;<span class="doctag">@code</span> null&#125;.  (There can be at most one such mapping.)</span><br><span class="line">     *</span><br><span class="line">     * &lt;p&gt;A return value of &#123;<span class="doctag">@code</span> null&#125; does not &lt;i&gt;necessarily&lt;/i&gt;</span><br><span class="line">     * indicate that the map contains no mapping for the key; it's also</span><br><span class="line">     * possible that the map explicitly maps the key to &#123;<span class="doctag">@code</span> null&#125;.</span><br><span class="line">     * The &#123;<span class="doctag">@link</span> #containsKey containsKey&#125; operation may be used to</span><br><span class="line">     * distinguish these two cases.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@see</span> #put(Object, Object)</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">        Object k = maskNull(key);</span><br><span class="line">        <span class="keyword">int</span> h = hash(k);</span><br><span class="line">        Entry&lt;K,V&gt;[] tab = getTable();</span><br><span class="line">        <span class="keyword">int</span> index = indexFor(h, tab.length);</span><br><span class="line">        Entry&lt;K,V&gt; e = tab[index];</span><br><span class="line">        <span class="keyword">while</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e.hash == h &amp;&amp; eq(k, e.get()))</span><br><span class="line">                <span class="keyword">return</span> e.value;</span><br><span class="line">            e = e.next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Returns the table after first expunging stale entries.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> Entry&lt;K,V&gt;[] getTable() &#123;</span><br><span class="line">        expungeStaleEntries();</span><br><span class="line">        <span class="keyword">return</span> table;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Expunges stale entries from the table.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">expungeStaleEntries</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Object x; (x = queue.poll()) != <span class="keyword">null</span>; ) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (queue) &#123;</span><br><span class="line">                <span class="annotation">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">                    Entry&lt;K,V&gt; e = (Entry&lt;K,V&gt;) x;</span><br><span class="line">                <span class="keyword">int</span> i = indexFor(e.hash, table.length);</span><br><span class="line"></span><br><span class="line">                Entry&lt;K,V&gt; prev = table[i];</span><br><span class="line">                Entry&lt;K,V&gt; p = prev;</span><br><span class="line">                <span class="keyword">while</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Entry&lt;K,V&gt; next = p.next;</span><br><span class="line">                    <span class="keyword">if</span> (p == e) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (prev == e)</span><br><span class="line">                            table[i] = next;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                            prev.next = next;</span><br><span class="line">                        <span class="comment">// Must not null out e.next;</span></span><br><span class="line">                        <span class="comment">// stale entries may be in use by a HashIterator</span></span><br><span class="line">                        e.value = <span class="keyword">null</span>; <span class="comment">// Help GC</span></span><br><span class="line">                        size--;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    prev = p;</span><br><span class="line">                    p = next;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * The entries in this hash table extend WeakReference, using its main ref</span><br><span class="line">     * field as the key.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">WeakReference</span>&lt;<span class="title">Object</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">        V value;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> hash;</span><br><span class="line">        Entry&lt;K,V&gt; next;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span><br><span class="line">         * Creates new entry.</span><br><span class="line">         */</span></span><br><span class="line">        Entry(Object key, V value,</span><br><span class="line">              ReferenceQueue&lt;Object&gt; queue,</span><br><span class="line">              <span class="keyword">int</span> hash, Entry&lt;K,V&gt; next) &#123;</span><br><span class="line">            <span class="keyword">super</span>(key, queue);</span><br><span class="line">            <span class="keyword">this</span>.value = value;</span><br><span class="line">            <span class="keyword">this</span>.hash  = hash;</span><br><span class="line">            <span class="keyword">this</span>.next  = next;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>逻辑非常清楚——一个通过链接法解决冲突的散列表。</p>
<p>其中有两个地方比较关键：</p>
<p>第一个，<code>Entity</code>的构造方法，传入了<code>ReferenceQueue</code>，这样当某个<code>WeakReference</code>被回收的时候将会进入队列；</p>
<p>第二个，<code>expungeStaleEntries()</code>，清除散列表中被回收的key，同时将value设为空（这个对GC帮助很大呀）。</p>
 -->
	
	</div>
  <a type="button" href="/2015/06/30/weak-reference/#more" class="btn btn-default more">Read More</a>
</div>

		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">
<ul class="pagination">
	 
		
          <li class="prev disabled"><a><i class="fa fa-arrow-circle-o-left"></i>Prev</a></li>
        

        <li><a href="/"><i class="fa fa-home"></i>Home</a></li>

		
		   <li class="next"> <a href="/page/2/" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a> </li>          
        
	
</ul>
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
<div class="widget">
  <h4>Recent Posts</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2015/11/03/password-strengths-evaluation-pcfg/" ><i class="fa fa-file-o"></i>Password Strengths Evaluati...</a>
      </li>
    
      <li>
        <a href="/2015/11/01/weekly/" ><i class="fa fa-file-o"></i>Weekly 2015-11-01...</a>
      </li>
    
      <li>
        <a href="/2015/10/25/weekly/" ><i class="fa fa-file-o"></i>Weekly 2015-10-25...</a>
      </li>
    
      <li>
        <a href="/2015/09/22/password-strengths-evaluation-entropy/" ><i class="fa fa-file-o"></i>Password Strengths Evaluati...</a>
      </li>
    
      <li>
        <a href="/2015/08/26/RSA-PKCS1-V1-5-Padding/" ><i class="fa fa-file-o"></i>BigInteger#toByteArray引发的处理...</a>
      </li>
    
  </ul>
</div>

		
			
<div class="widget">
	<h4>Links</h4>
	<ul class="blogroll list-unstyled">
	
		<li><i class="fa fa-github"></i><a href="http://www.github.com/shichaoyuan" title="My Github account." target="_blank"]);">My Github</a></li>
	
	</ul>
</div>


		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->
	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2015 Shichao Yuan
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a>. Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>.    
</p> </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 






<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>




<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</body>
   </html>
